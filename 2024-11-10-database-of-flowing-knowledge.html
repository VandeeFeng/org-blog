<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://www.vandee.art/rss.xml"
      title="RSS feed for https://www.vandee.art/">
<title>数据库的搭建 - 流动知识检索</title>
<meta property="og:title" content="数据库的搭建 - 流动知识检索">
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.vandee.art/2024-11-10-database-of-flowing-knowledge.html">
<meta name="author" content="Vandee">
       <meta name="referrer" content="no-referrer">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">

       <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
       <link rel="stylesheet"
             href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css"/>
       <link rel="stylesheet"
             href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.css"/>
       <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>

       <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" defer></script>
       <script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.umd.js" defer></script>
       <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js" defer></script>
       <script defer>
         document.addEventListener("DOMContentLoaded", function () {
           pangu.spacingPage();
         });
       </script>

       <script src="assets/js/app.js" defer></script>
       <script src="assets/js/copyCode.js" defer></script>
       <script src="assets/js/search.js" defer></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://www.vandee.art/">Vandee's Blog</a></h1>
      <nav>
      <a href="https://www.vandee.art/">Home</a>
      <a href="https://x.vandee.art/wiki">Wiki</a>
      <a href="https://x.vandee.art/photo">Photo</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<div class="post-date">10 Nov 2024</div><h1 class="post-title"><a href="https://www.vandee.art/2024-11-10-database-of-flowing-knowledge.html">数据库的搭建 - 流动知识检索</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org42429c0">同步保存到 Readwise</a>
<ul>
<li><a href="#orgaebc473">python</a></li>
<li><a href="#orge63a2de">workflow</a></li>
</ul>
</li>
<li><a href="#org7dde572">Teable</a>
<ul>
<li><a href="#orgaa8c5b6">Python</a></li>
<li><a href="#org70e9579">workflow</a></li>
<li><a href="#org44da16c">bash</a></li>
</ul>
</li>
<li><a href="#org15c9ac8">PocketBase</a>
<ul>
<li><a href="#orgcb0350f">docker 部署到 VPS</a></li>
<li><a href="#org0078a11">Python</a></li>
<li><a href="#orgf84df6b">workflow</a></li>
</ul>
</li>
<li><a href="#org6b7e62c">Readwise highlights</a>
<ul>
<li><a href="#orgea8698e">python</a></li>
<li><a href="#org3c6c127">workflow</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
Readwise 是我体验的最舒服的 after-reading 软件了，之前一直没有利用好它的 API，在 PKM 体系里，也一直没有统一到工作流。而这些流动知识的数据越来越多，以 10 年 20 年来度量，必须用数据库来完善和管理了，也是碰巧看到了这个项目：<a href="https://github.com/pocketbase/pocketbase">pocketbase/pocketbase: Open Source realtime backend in 1 file</a> ,很简洁的管理 UI，支持 S3 数据备份，支持 API 导入和导出。还有一个更轻量的选择 <a href="https://github.com/teableio/teable">teableio/teable: ✨ The Next Gen Airtable Alternative: No-Code Postgres</a> ，用了半年了，之前一直没好好看它们的 API，只是不能直接用数据库的 API 导入数据，但是是可以直接用 API 添加 Record 到表格的。
</p>

<p>
pocketbase 这个项目的优势是更适合长文内容的保存，内置编辑器，但是不支持直接导入表格或 csv 文件，但可以导入 JSON 和 S3 自动备份。
</p>

<p>
teable 则更偏向于可视化表格，不太适合长文内容的保存。由于我的长文都用 clip 保存了，clip 面向阅读体验，而teable 用来快速的查询，面向数据。现在只保存了三个 field：title，url，和一句话内容总结，方便我时间长了之后回忆和查找相关文章。
</p>

<p>
在 Claude 的协助下，有了现在的方案。
</p>

<p>
主要思路：利用 GitHub 为中转站， <code>osmos::memos</code> 插件保存文章，同步保存到 Readwise 进行阅读和高亮，再同步保存到 pocketbase 或 teable 做数据库处理。现在暂时选择了 teable 的方案。
</p>

<div id="outline-container-org42429c0" class="outline-2">
<h2 id="org42429c0">同步保存到 Readwise</h2>
<div class="outline-text-2" id="text-org42429c0">
<p>
现在使用 <code>osmos::memos</code> 插件保存的时候，会默认也保存到 readwise。添加 <code>#2clip</code> 标签触发 clip 的 workflow。详见： <a href="https://www.vandee.art/2024-10-12-bookmark-and-summary-by-github-actions.html">用 GitHub 仓库做书签和 AI 摘要 - 流动知识检索</a>
</p>

<p>
这样就统一起来了。所有的链接都保存在 bookmark-collection 仓库作为中转站，然后统一在 Readwise 里阅读，导出 highlights。有保存价值的会触发 clip workflow 保存原文。
</p>

<p>
主要思路：在 push 的时候会运行这个 Python 脚本，读取新增内容，获取 URL 并使用 Readwise Reader 的 API 保存到 Readwise Reader。Readwise 和 Readwise Reader 是两个 API。
</p>

<p>
需要在仓库的 secret 里增加一个 <code>READWISE_TOKEN</code> secert，填入自己的 Readwise API。
</p>
</div>
<div id="outline-container-orgaebc473" class="outline-3">
<h3 id="orgaebc473">python</h3>
<div class="outline-text-3" id="text-orgaebc473">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #FF7B72;">import</span> os
<span style="color: #FF7B72;">import</span> re
<span style="color: #FF7B72;">import</span> logging
<span style="color: #FF7B72;">import</span> requests
<span style="color: #FF7B72;">from</span> github <span style="color: #FF7B72;">import</span> Github

logging.basicConfig<span style="color: #8c8c8c;">(</span>
    level=logging.INFO,
    <span style="color: #79C0FF;">format</span>=<span style="color: #a7bca4;">'%(asctime)s - %(message)s'</span>,
    datefmt=<span style="color: #a7bca4;">'%Y-%m-%d %H:%M:%S'</span>
<span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_added_content</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;">"""&#33719;&#21462;&#36825;&#27425;&#25552;&#20132;&#26032;&#22686;&#30340;&#20869;&#23481;"""</span>
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #FFA657;">commit_sha</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'GITHUB_SHA'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">commit</span> = repo.get_commit<span style="color: #8c8c8c;">(</span>commit_sha<span style="color: #8c8c8c;">)</span>

        <span style="color: #FF7B72;">for</span> <span style="color: #79C0FF;">file</span> <span style="color: #FF7B72;">in</span> commit.files:
            <span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">file</span>.filename.endswith<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'.md'</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">file</span>.patch <span style="color: #FF7B72;">and</span> <span style="color: #a7bca4;">'+'</span> <span style="color: #FF7B72;">in</span> <span style="color: #79C0FF;">file</span>.patch:
                    <span style="color: #FFA657;">added_lines</span> = <span style="color: #8c8c8c;">[</span>line<span style="color: #93a8c6;">[</span>1:<span style="color: #93a8c6;">]</span> <span style="color: #FF7B72;">for</span> line <span style="color: #FF7B72;">in</span> <span style="color: #79C0FF;">file</span>.patch.split<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'</span><span style="font-style: italic;">\n</span><span style="color: #a7bca4;">'</span><span style="color: #93a8c6;">)</span>
                                 <span style="color: #FF7B72;">if</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'+'</span><span style="color: #93a8c6;">)</span> <span style="color: #FF7B72;">and</span> <span style="color: #FF7B72;">not</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'+++'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
                    <span style="color: #FF7B72;">return</span> added_lines
        <span style="color: #FF7B72;">return</span> <span style="color: #8c8c8c;">[]</span>

    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error getting commit content: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">extract_url</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span>:
    <span style="color: #787878; font-style: italic;">"""&#20174;&#34892;&#20013;&#25552;&#21462;URL&#65292;&#25903;&#25345;markdown&#26684;&#24335;&#30340;&#38142;&#25509;"""</span>
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#21518;&#30340;URL&#25552;&#21462;&#27169;&#24335;</span>
    <span style="color: #FFA657;">url_pattern</span> = r<span style="color: #a7bca4;">'\((https?://[\w\-._~:/?#\[\]@!$&amp;\'()*+,;=.%]+)\)'</span>
    <span style="color: #FF7B72;">match</span> = re.search<span style="color: #8c8c8c;">(</span>url_pattern, line<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">match</span>:
        <span style="color: #FF7B72;">return</span> <span style="color: #FF7B72;">match</span>.group<span style="color: #8c8c8c;">(</span>1<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">return</span> <span style="font-style: italic;">None</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">has_clip_tag</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">bool</span>:
    <span style="color: #787878; font-style: italic;">"""&#26816;&#26597;&#26159;&#21542;&#21253;&#21547; #2clip &#26631;&#31614;"""</span>
    <span style="color: #FF7B72;">return</span> <span style="color: #79C0FF;">bool</span><span style="color: #8c8c8c;">(</span>re.search<span style="color: #93a8c6;">(</span>r<span style="color: #a7bca4;">'#2clip\b'</span>, line<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">trigger_workflow</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;">"""&#35302;&#21457;&#21478;&#19968;&#20010;workflow"""</span>
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #FFA657;">workflow</span> = repo.get_workflow<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"bookmark_summary.yml"</span><span style="color: #8c8c8c;">)</span>
        workflow.create_dispatch<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"main"</span><span style="color: #8c8c8c;">)</span>
        logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Successfully triggered the bookmark_summary workflow"</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Failed to trigger workflow: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">main</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#33719;&#21462;&#25152;&#26377;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #FFA657;">added_lines</span> = get_added_content<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> added_lines:
            logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"No new markdown content found in this commit"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">return</span>

        <span style="color: #FFA657;">trigger_needed</span> = <span style="font-style: italic;">False</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22788;&#29702;&#27599;&#19968;&#34892;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #FF7B72;">for</span> line <span style="color: #FF7B72;">in</span> added_lines:
            <span style="color: #FFA657;">line</span> = line.strip<span style="color: #8c8c8c;">()</span>
            logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Processing line: </span>{line}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26816;&#26597;&#26631;&#31614;</span>
            <span style="color: #FF7B72;">if</span> has_clip_tag<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>:
                <span style="color: #FFA657;">trigger_needed</span> = <span style="font-style: italic;">True</span>
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Found #2clip tag"</span><span style="color: #8c8c8c;">)</span>

            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#25552;&#21462;&#24182;&#22788;&#29702;URL&#65288;&#26080;&#35770;&#26159;&#21542;&#26377;&#26631;&#31614;&#65289;</span>
            <span style="color: #FFA657;">url</span> = extract_url<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">if</span> url:
                <span style="color: #FF7B72;">try</span>:
                    <span style="color: #FFA657;">response</span> = requests.post<span style="color: #8c8c8c;">(</span>
                        url=<span style="color: #a7bca4;">"https://readwise.io/api/v3/save/"</span>,
                        headers=<span style="color: #93a8c6;">{</span><span style="color: #a7bca4;">"Authorization"</span>: f<span style="color: #a7bca4;">"Token </span>{os.environ['READWISE_TOKEN']}<span style="color: #a7bca4;">"</span><span style="color: #93a8c6;">}</span>,
                        json=<span style="color: #93a8c6;">{</span>
                            <span style="color: #a7bca4;">"url"</span>: url,
                            <span style="color: #a7bca4;">"tags"</span>: <span style="color: #b0b1a3;">[</span><span style="color: #a7bca4;">"Bookmark"</span><span style="color: #b0b1a3;">]</span>
                        <span style="color: #93a8c6;">}</span>
                    <span style="color: #8c8c8c;">)</span>
                    response.raise_for_status<span style="color: #8c8c8c;">()</span>
                    logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Successfully saved URL: </span>{url}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">except</span> requests.exceptions.RequestException <span style="color: #FF7B72;">as</span> e:
                    logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Failed to save URL </span>{url}<span style="color: #a7bca4;">: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22914;&#26524;&#21457;&#29616;&#20102;&#26631;&#31614;&#65292;&#35302;&#21457;workflow</span>
        <span style="color: #FF7B72;">if</span> trigger_needed:
            logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Triggering workflow due to #2clip tag"</span><span style="color: #8c8c8c;">)</span>
            trigger_workflow<span style="color: #8c8c8c;">()</span>

    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #a7bca4;">"__main__"</span>:
    main<span style="color: #8c8c8c;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge63a2de" class="outline-3">
<h3 id="orge63a2de">workflow</h3>
<div class="outline-text-3" id="text-orge63a2de">
<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #FFA657;">name</span>: Save Bookmark to Readwise

<span style="font-style: italic;">on</span>:
  <span style="color: #FFA657;">push</span>:
    <span style="color: #FFA657;">branches</span>:
      - main
    <span style="color: #FFA657;">paths</span>:
      - <span style="color: #a7bca4;">'**.md'</span>
  <span style="color: #FFA657;">workflow_dispatch</span>:

<span style="color: #FFA657;">permissions</span>:
  <span style="color: #FFA657;">contents</span>: read
  <span style="color: #FFA657;">actions</span>: write

<span style="color: #FFA657;">jobs</span>:
  <span style="color: #FFA657;">save-to-readwise</span>:
    <span style="color: #FFA657;">runs-on</span>: ubuntu-latest

    <span style="color: #FFA657;">steps</span>:
    - <span style="color: #FFA657;">name</span>: Checkout repository
      <span style="color: #FFA657;">uses</span>: actions/checkout@v4
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">token</span>: ${{ secrets.GITHUB_TOKEN }}

    - <span style="color: #FFA657;">name</span>: Set up Python
      <span style="color: #FFA657;">uses</span>: actions/setup-python@v4
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">python-version</span>: <span style="color: #a7bca4;">'3.10'</span>

    - <span style="color: #FFA657;">name</span>: Install dependencies
      <span style="color: #FFA657;">run</span>: |
        <span style="color: #a7bca4;">python -m pip install --upgrade pip</span>
<span style="color: #a7bca4;">        pip install requests PyGithub</span>

    - <span style="color: #FFA657;">name</span>: Run bookmark saver
      <span style="color: #FFA657;">env</span>:
        <span style="color: #FFA657;">READWISE_TOKEN</span>: ${{ secrets.READWISE_TOKEN }}
        <span style="color: #FFA657;">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style="color: #FFA657;">GITHUB_REPOSITORY</span>: ${{ github.repository }}
      <span style="color: #FFA657;">run</span>: python save_to_readwise.py

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7dde572" class="outline-2">
<h2 id="org7dde572">Teable</h2>
<div class="outline-text-2" id="text-org7dde572">
<p>
在 bookmark-collection 仓库增加两个 secret： <code>TEABLE_TABLE_ID</code> ， <code>TEABLE_TOKEN</code> 。
</p>

<p>
<code>TEABLE_TABLE_ID</code> 就是要写入表格的 ID，在地址栏的 <code>&amp;tableId=</code> 后面就是 ID 了。 <code>TEABLE_TOKEN</code> 就是 API 。
</p>
</div>
<div id="outline-container-orgaa8c5b6" class="outline-3">
<h3 id="orgaa8c5b6">Python</h3>
<div class="outline-text-3" id="text-orgaa8c5b6">
<p>
在 bookmark-summary 里修改 py 脚本：
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="color: #FF7B72;">import</span> re
<span style="color: #FF7B72;">from</span> typing <span style="color: #FF7B72;">import</span> List, Optional
<span style="color: #FF7B72;">import</span> requests
<span style="color: #FF7B72;">import</span> json
<span style="color: #FF7B72;">from</span> datetime <span style="color: #FF7B72;">import</span> datetime
<span style="color: #FF7B72;">from</span> pathlib <span style="color: #FF7B72;">import</span> Path
<span style="color: #FF7B72;">from</span> dataclasses <span style="color: #FF7B72;">import</span> dataclass, asdict
<span style="color: #FF7B72;">import</span> os
<span style="color: #FF7B72;">import</span> logging
<span style="color: #FF7B72;">import</span> time
<span style="color: #FF7B72;">from</span> functools <span style="color: #FF7B72;">import</span> wraps
<span style="color: #FF7B72;">from</span> urllib.parse <span style="color: #FF7B72;">import</span> quote
<span style="color: #FF7B72;">import</span> http.client

<span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">-- configurations begin --</span>
<span style="color: #FFA657;">BOOKMARK_COLLECTION_REPO_NAME</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">"bookmark-collection"</span>
<span style="color: #FFA657;">BOOKMARK_SUMMARY_REPO_NAME</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">"bookmark-summary"</span>
<span style="color: #FFA657;">TEABLE_TABLE_ID</span>: <span style="color: #79C0FF;">str</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'TEABLE_TABLE_ID'</span><span style="color: #8c8c8c;">)</span>
<span style="color: #FFA657;">TEABLE_TOKEN</span>: <span style="color: #79C0FF;">str</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'TEABLE_TOKEN'</span><span style="color: #8c8c8c;">)</span>
<span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">-- configurations end --</span>

logging.basicConfig<span style="color: #8c8c8c;">(</span>
    level=logging.INFO,
    <span style="color: #79C0FF;">format</span>=<span style="color: #a7bca4;">'%(asctime)s - %(filename)s:%(lineno)d - %(funcName)s - %(message)s'</span>,
    datefmt=<span style="color: #a7bca4;">'%Y-%m-%d %H:%M:%S'</span>
<span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">log_execution_time</span><span style="color: #8c8c8c;">(</span>func<span style="color: #8c8c8c;">)</span>:
    <span style="color: #FF7B72; font-style: italic;">@wraps</span><span style="color: #8c8c8c;">(</span>func<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">wrapper</span><span style="color: #8c8c8c;">(</span>*args, **kwargs<span style="color: #8c8c8c;">)</span>:
        logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'Entering </span>{func.<span style="color: #79C0FF;">__name__</span>}<span style="color: #a7bca4;">'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">start_time</span> = time.time<span style="color: #8c8c8c;">()</span>
        <span style="color: #FFA657;">result</span> = func<span style="color: #8c8c8c;">(</span>*args, **kwargs<span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">end_time</span> = time.time<span style="color: #8c8c8c;">()</span>
        <span style="color: #FFA657;">elapsed_time</span> = end_time - start_time
        logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'Exiting </span>{func.<span style="color: #79C0FF;">__name__</span>}<span style="color: #a7bca4;"> - Elapsed time: </span>{elapsed_time:.4f}<span style="color: #a7bca4;"> seconds'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">return</span> result
    <span style="color: #FF7B72;">return</span> wrapper

<span style="color: #FF7B72; font-style: italic;">@dataclass</span>
<span style="color: #FF7B72;">class</span> <span style="color: #FF7B72; font-style: italic;">SummarizedBookmark</span>:
    year: <span style="color: #79C0FF;">str</span>
    month: <span style="color: #79C0FF;">str</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">yyyyMM</span>
    title: <span style="color: #79C0FF;">str</span>
    url: <span style="color: #79C0FF;">str</span>
    timestamp: <span style="color: #79C0FF;">int</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">unix timestamp</span>
    summary: <span style="color: #79C0FF;">str</span>

<span style="color: #FFA657;">CURRENT_YEAR</span>: <span style="color: #79C0FF;">str</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y'</span><span style="color: #8c8c8c;">)</span>
<span style="color: #FFA657;">CURRENT_MONTH</span>: <span style="color: #79C0FF;">str</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%m'</span><span style="color: #8c8c8c;">)</span>
<span style="color: #FFA657;">CURRENT_DATE</span>: <span style="color: #79C0FF;">str</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
<span style="color: #FFA657;">CURRENT_DATE_AND_TIME</span>: <span style="color: #79C0FF;">str</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y-%m-%d %H:%M:%S'</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_text_content</span><span style="color: #8c8c8c;">(</span>url: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">jina_url</span>: <span style="color: #79C0FF;">str</span> = f<span style="color: #a7bca4;">"https://r.jina.ai/</span>{url}<span style="color: #a7bca4;">"</span>
    <span style="color: #FFA657;">response</span>: requests.Response = requests.get<span style="color: #8c8c8c;">(</span>jina_url<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">return</span> response.text

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">call_openai_api</span><span style="color: #8c8c8c;">(</span>prompt: <span style="color: #79C0FF;">str</span>, content: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">model</span>: <span style="color: #79C0FF;">str</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'OPENAI_API_MODEL'</span>, <span style="color: #a7bca4;">'gpt-4o-mini'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">headers</span>: <span style="color: #79C0FF;">dict</span> = <span style="color: #8c8c8c;">{</span>
        <span style="color: #a7bca4;">"Authorization"</span>: f<span style="color: #a7bca4;">"Bearer </span>{os.environ['OPENAI_API_KEY']}<span style="color: #a7bca4;">"</span>,
        <span style="color: #a7bca4;">"Content-Type"</span>: <span style="color: #a7bca4;">"application/json"</span>
    <span style="color: #8c8c8c;">}</span>
    <span style="color: #FFA657;">data</span>: <span style="color: #79C0FF;">dict</span> = <span style="color: #8c8c8c;">{</span>
        <span style="color: #a7bca4;">"model"</span>: model,
        <span style="color: #a7bca4;">"messages"</span>: <span style="color: #93a8c6;">[</span>
            <span style="color: #b0b1a3;">{</span><span style="color: #a7bca4;">"role"</span>: <span style="color: #a7bca4;">"system"</span>, <span style="color: #a7bca4;">"content"</span>: prompt<span style="color: #b0b1a3;">}</span>,
            <span style="color: #b0b1a3;">{</span><span style="color: #a7bca4;">"role"</span>: <span style="color: #a7bca4;">"user"</span>, <span style="color: #a7bca4;">"content"</span>: content<span style="color: #b0b1a3;">}</span>
        <span style="color: #93a8c6;">]</span>
    <span style="color: #8c8c8c;">}</span>
    <span style="color: #FFA657;">api_endpoint</span>: <span style="color: #79C0FF;">str</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'OPENAI_API_ENDPOINT'</span>, <span style="color: #a7bca4;">'https://api.openai.com/v1/chat/completions'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">response</span>: requests.Response = requests.post<span style="color: #8c8c8c;">(</span>api_endpoint, headers=headers, data=json.dumps<span style="color: #93a8c6;">(</span>data<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">return</span> response.json<span style="color: #8c8c8c;">()[</span><span style="color: #a7bca4;">'choices'</span><span style="color: #8c8c8c;">][</span>0<span style="color: #8c8c8c;">][</span><span style="color: #a7bca4;">'message'</span><span style="color: #8c8c8c;">][</span><span style="color: #a7bca4;">'content'</span><span style="color: #8c8c8c;">]</span>
<span style="color: #a7bca4;">'''</span>
<span style="color: #a7bca4;">def clean_prompt(prompt: str) -&gt; str:</span>
<span style="color: #a7bca4;">    """&#28165;&#29702;&#21644;&#39564;&#35777;prompt&#26684;&#24335;"""</span>
<span style="color: #a7bca4;">    # &#31227;&#38500;&#22810;&#20313;&#30340;&#31354;&#30333;&#23383;&#31526;</span>
<span style="color: #a7bca4;">    prompt = prompt.strip()</span>
<span style="color: #a7bca4;">    # &#30830;&#20445;XML&#22768;&#26126;&#22312;&#31532;&#19968;&#34892;</span>
<span style="color: #a7bca4;">    if not prompt.startswith('&lt;?xml'):</span>
<span style="color: #a7bca4;">        prompt = '&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span><span style="font-style: italic;">\n</span><span style="color: #a7bca4;">' + prompt</span>
<span style="color: #a7bca4;">    # &#39564;&#35777;XML&#26684;&#24335;</span>
<span style="color: #a7bca4;">    try:</span>
<span style="color: #a7bca4;">        from xml.etree import ElementTree</span>
<span style="color: #a7bca4;">        ElementTree.fromstring(prompt)</span>
<span style="color: #a7bca4;">    except ElementTree.ParseError as e:</span>
<span style="color: #a7bca4;">        logging.warning(f"Prompt XML format warning: {e}")</span>
<span style="color: #a7bca4;">    return prompt</span>
<span style="color: #a7bca4;">'''</span>

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">summarize_text</span><span style="color: #8c8c8c;">(</span>text: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">prompt</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">"""</span>
<span style="color: #a7bca4;">{#- &#29992;&#31616;&#20307;&#20013;&#25991;&#20013;&#25991;&#36914;&#34892;&#25991;&#31456;&#25688;&#35201; -#}</span>

<span style="color: #a7bca4;">## Profile:&#8203;</span>
<span style="color: #a7bca4;">- author: Vandee&#8203;</span>
<span style="color: #a7bca4;">- role: &#25991;&#31456;&#20869;&#23481;&#28145;&#24230;&#24635;&#32467;&#24605;&#32771;&#21161;&#25163;</span>
<span style="color: #a7bca4;">- language: &#20013;&#25991;&#8203;</span>
<span style="color: #a7bca4;">- description: &#20840;&#38754;&#30340;&#24635;&#32467;&#25991;&#31456;&#30340;&#20027;&#35201;&#35266;&#28857;&#65292;&#24182;&#32467;&#21512;&#20005;&#35880;&#30340;&#36923;&#36753;&#24605;&#32500;&#20998;&#26512;&#25991;&#31456;&#35201;&#28857;&#65292;&#21078;&#26512;&#25991;&#31456;&#20869;&#23481;&#12290;</span>

<span style="color: #a7bca4;">## Goals:</span>
<span style="color: #a7bca4;">- &#31532;&#19968;&#27493;&#65292;&#20180;&#32454;&#38405;&#35835;&#25991;&#31456;&#20869;&#23481;&#12290;</span>
<span style="color: #a7bca4;">- &#31532;&#20108;&#27493;,&#23545;&#27599;&#20010;&#27573;&#33853;&#36827;&#34892;&#24635;&#32467;,&#24635;&#32467;&#25991;&#31456;&#30340;&#20027;&#35201;&#20869;&#23481;&#65292;&#29702;&#28165;&#26970;&#20316;&#32773;&#34920;&#36798;&#20102;&#20160;&#20040;&#35266;&#28857;&#12289;&#20316;&#32773;&#35299;&#20915;&#20102;&#37027;&#20123;&#20855;&#20307;&#30340;&#38382;&#39064;&#12290;</span>
<span style="color: #a7bca4;">- &#31532;&#19977;&#27493;,&#25991;&#31456;&#35201;&#28857;&#24635;&#32467;&#12290;&#26681;&#25454;&#21407;&#25991;&#20869;&#23481;,&#25552;&#28860;&#20986;&#25991;&#31456;&#30340;5&#20010;&#20197;&#20869;&#30340;&#20027;&#35201;&#35266;&#28857;&#25110;&#20316;&#32773;&#35299;&#20915;&#30340;&#38382;&#39064;&#12290;</span>
<span style="color: #a7bca4;">- &#31532;&#22235;&#27493;,&#26681;&#25454;&#19978;&#38754;&#19977;&#27493;&#65292;&#25353;&#29031;&#25351;&#23450;&#30340;&#36755;&#20986;&#26684;&#24335;,&#25972;&#29702;&#20986;&#25991;&#31456;&#20869;&#23481;&#30340;&#24635;&#32467;&#12290;</span>

<span style="color: #a7bca4;">## Constrains:&#8203;</span>
<span style="color: #a7bca4;">- &#25991;&#31456;&#20869;&#23481;&#24635;&#32467;&#30340;{&#25688;&#35201;}&#23383;&#25968;&#25511;&#21046;&#22312;380&#20010;&#20013;&#25991;&#27721;&#23383;&#20197;&#20869;&#12290;</span>
<span style="color: #a7bca4;">- &#23613;&#21487;&#33021;&#36824;&#21407;&#25991;&#31456;&#20013;&#30340;&#19987;&#19994;&#35789;&#27719;,&#24182;&#23545;&#20854;&#36827;&#34892;&#36890;&#20439;&#35299;&#37322;&#12290;</span>
<span style="color: #a7bca4;">- &#22312;&#24635;&#32467;&#30340;&#36807;&#31243;&#20013;,&#23436;&#20840;&#25353;&#29031;&#25991;&#31456;&#20316;&#32773;&#30340;&#34920;&#36798;&#20869;&#23481;&#36827;&#34892;&#25972;&#29702;,&#19981;&#28155;&#21152;&#20320;&#30340;&#39069;&#22806;&#35266;&#28857;&#12290;</span>
<span style="color: #a7bca4;">- &#25152;&#26377;&#36755;&#20986;&#29992;&#20013;&#25991;&#29983;&#25104;&#12290;</span>
<span style="color: #a7bca4;">- &#25991;&#31456;&#20869;&#23481;&#37324;&#30340;"&#25105;&#8220;&#26159;&#25991;&#31456;&#30340;&#21407;&#20316;&#32773;&#65292;&#19981;&#35201;&#20195;&#20837; Vandee &#30340;&#36523;&#20221;&#12290;</span>

<span style="color: #a7bca4;">## Skills:&#8203;</span>
<span style="color: #a7bca4;">- &#21892;&#20110;&#29992;&#27969;&#30021;&#36890;&#39034;&#30340;&#31616;&#20307;&#20013;&#25991;&#24635;&#32467;&#20869;&#23481;&#37325;&#28857;&#12290;</span>
<span style="color: #a7bca4;">- &#20855;&#26377;&#33391;&#22909;&#30340;&#36923;&#36753;&#24605;&#32500;&#33021;&#21147;,&#33021;&#22815;&#28145;&#20837;&#20998;&#26512;&#25991;&#31456;&#20869;&#23481;&#12290;</span>
<span style="color: #a7bca4;">- &#25484;&#25569;&#25991;&#31456;&#30456;&#20851;&#39046;&#22495;&#30340;&#19987;&#19994;&#30693;&#35782;,&#33021;&#22815;&#20934;&#30830;&#29702;&#35299;&#21644;&#38416;&#36848;&#19987;&#19994;&#27010;&#24565;&#12290;</span>
<span style="color: #a7bca4;">- &#25797;&#38271;&#20197;&#36890;&#20439;&#26131;&#25026;&#30340;&#26041;&#24335;&#35299;&#37322;&#22797;&#26434;&#30340;&#19987;&#19994;&#20869;&#23481;&#12290;</span>

<span style="color: #a7bca4;">## Workflows:&#8203;</span>
<span style="color: #a7bca4;">- &#36880;&#27573;&#38405;&#35835;&#25991;&#31456;&#20869;&#23481;&#12290;</span>
<span style="color: #a7bca4;">- &#24635;&#32467;&#25991;&#31456;&#30340;&#20869;&#23481;&#24182;&#29983;&#25104;{&#25688;&#35201;}&#12290;&#36825;&#19968;&#27493;&#20320;&#38656;&#35201;&#20840;&#38754;&#29702;&#35299;&#25991;&#31456;&#20869;&#23481;&#30340;&#20027;&#39064;&#12289;&#20869;&#23481;&#30340;&#36923;&#36753;&#26694;&#26550;&#12289;&#20316;&#32773;&#30340;&#25552;&#20986;&#30340;&#35266;&#28857;&#65292;&#25688;&#35201;&#19981;&#23569;&#20110;270&#20010;&#20013;&#25991;&#27721;&#23383;&#12290;</span>
<span style="color: #a7bca4;">- &#20877;&#27425;&#22238;&#39038;&#21407;&#25991;&#25152;&#26377;&#20869;&#23481;&#65292;&#22312;&#19978;&#19968;&#27493;&#24635;&#32467;&#20986;{&#25688;&#35201;}&#30340;&#22522;&#30784;&#19978;&#65292;&#36827;&#34892;&#28145;&#20837;&#20998;&#26512;&#12290;&#36825;&#19968;&#27493;&#20320;&#38656;&#35201;&#29702;&#28165;&#36825;&#20123;&#20869;&#23481;&#20043;&#38388;&#30340;&#36923;&#36753;&#20851;&#31995;&#12289;&#19987;&#19994;&#27010;&#24565;&#12289;&#21517;&#35789;&#27010;&#24565;&#65292;&#24182;&#30528;&#37325;&#20851;&#27880;&#21407;&#25991;&#20869;&#23481;&#37324;&#22810;&#27425;&#20986;&#29616;&#30340;&#35789;&#27719;&#25110;&#27010;&#24565;&#65292;&#29305;&#21035;&#20851;&#27880;&#20316;&#32773;&#25552;&#20986;&#20102;&#20160;&#20040;&#35266;&#28857;&#12289;&#20316;&#32773;&#35299;&#20915;&#20102;&#37027;&#20123;&#20855;&#20307;&#30340;&#38382;&#39064;&#12289;&#20316;&#32773;&#20307;&#24735;&#20986;&#20102;&#21738;&#20123;&#36947;&#29702;&#12289;&#20316;&#32773;&#24471;&#20986;&#20102;&#20160;&#20040;&#37325;&#22823;&#30340;&#30740;&#31350;&#32467;&#35770;&#65292;&#26368;&#21518;&#26803;&#29702;&#20986;{&#31934;&#28860;&#20869;&#23481;}&#12290;</span>
<span style="color: #a7bca4;">- &#26681;&#25454;&#21407;&#25991;&#20869;&#23481;&#21644;&#20320;&#19978;&#19968;&#27493;&#30340;{&#31934;&#28860;&#20869;&#23481;}&#65292;&#25552;&#28860;&#20986;&#25991;&#31456;&#30340;&#33267;&#23569;4&#20010;&#35201;&#28857;&#29983;&#25104;{&#35201;&#28857;&#24635;&#32467;}&#65292;&#20320;&#19981;&#29992;&#36755;&#20986;{&#31934;&#28860;&#20869;&#23481;}&#12290;</span>
<span style="color: #a7bca4;">- &#20320;&#38656;&#35201;&#25353;&#29031;markdown&#26377;&#24207;&#21015;&#34920;&#30340;&#26684;&#24335;&#21015;&#20986;&#19978;&#19968;&#27493;{&#35201;&#28857;&#24635;&#32467;}&#20013;&#30340;&#35201;&#28857;&#65292;&#24182;&#26681;&#25454;&#35201;&#28857;&#25152;&#22312;&#30340;&#21407;&#25991;&#24182;&#20005;&#26684;&#26681;&#25454;&#25991;&#31456;&#20869;&#23481;&#25193;&#23637;&#23545;&#35813;&#35201;&#28857;&#30340;&#35299;&#26512;&#65292;&#26041;&#20415;&#35835;&#32773;&#29702;&#35299;&#36825;&#20123;&#35201;&#28857;&#30340;&#24847;&#24605;&#12290;</span>
<span style="color: #a7bca4;">- &#25353;&#29031;&#25351;&#23450;&#30340;&#36755;&#20986;&#26684;&#24335;,&#25972;&#29702;&#20986;&#25991;&#31456;&#20869;&#23481;&#30340;&#24635;&#32467;&#12290;&#8220;&#25688;&#35201;&#8220;&#21644;&#8221;&#35201;&#28857;&#24635;&#32467;&#8220;&#21482;&#38656;&#35201;&#25353;&#29031;markdown&#26684;&#24335;&#21152;&#31895;&#65292;&#19981;&#35201;&#29992;&#26631;&#39064;&#26684;&#24335;&#12290;</span>

<span style="color: #a7bca4;">## OutputFormat:</span>
<span style="color: #a7bca4;">**&#25688;&#35201;**&#65306;</span>
<span style="color: #a7bca4;">{&#25688;&#35201;}</span>
<span style="color: #a7bca4;">**&#35201;&#28857;&#24635;&#32467;**&#65306;</span>
<span style="color: #a7bca4;">{&#35201;&#28857;&#24635;&#32467;}</span>
<span style="color: #a7bca4;">"""</span>
    <span style="color: #FFA657;">result</span> = call_openai_api<span style="color: #8c8c8c;">(</span>prompt, text<span style="color: #8c8c8c;">)</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20808;&#35843;&#29992; API &#24182;&#23384;&#20648;&#32467;&#26524;</span>
    time.sleep<span style="color: #8c8c8c;">(</span>1<span style="color: #8c8c8c;">)</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#31561;&#24453; 1 &#31186;</span>
    <span style="color: #FF7B72;">return</span> result  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#36820;&#22238;&#32467;&#26524;</span>

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">one_sentence_summary</span><span style="color: #8c8c8c;">(</span>text: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">prompt</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">"&#20197;&#19979;&#26159;&#23545;&#19968;&#31687;&#38271;&#25991;&#30340;&#21015;&#34920;&#24418;&#24335;&#24635;&#32467;&#12290;&#35831;&#22522;&#20110;&#27492;&#36755;&#20986;&#23545;&#35813;&#25991;&#31456;&#30340;&#31616;&#30701;&#24635;&#32467;&#65292;&#38271;&#24230;&#19981;&#36229;&#36807;100&#20010;&#23383;&#12290;&#24635;&#26159;&#20351;&#29992;&#31616;&#20307;&#20013;&#25991;&#36755;&#20986;&#12290;"</span>
    <span style="color: #FF7B72;">return</span> call_openai_api<span style="color: #8c8c8c;">(</span>prompt, text<span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">slugify</span><span style="color: #8c8c8c;">(</span>text: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">invalid_fs_chars</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">'/</span><span style="font-style: italic;">\\</span><span style="color: #a7bca4;">:*?"&lt;&gt;|'</span>
    <span style="color: #FF7B72;">return</span> re.sub<span style="color: #8c8c8c;">(</span>r<span style="color: #a7bca4;">'['</span> + re.escape<span style="color: #93a8c6;">(</span>invalid_fs_chars<span style="color: #93a8c6;">)</span> + r<span style="color: #a7bca4;">'\s]+'</span>, <span style="color: #a7bca4;">'-'</span>, text.lower<span style="color: #93a8c6;">()</span><span style="color: #8c8c8c;">)</span>.strip<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'-'</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_summary_file_path</span><span style="color: #8c8c8c;">(</span>title: <span style="color: #79C0FF;">str</span>, timestamp: <span style="color: #79C0FF;">int</span>, year: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>, month: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>, in_readme_md: <span style="color: #79C0FF;">bool</span> = <span style="font-style: italic;">False</span><span style="color: #8c8c8c;">)</span> -&gt; Path:
    <span style="color: #FFA657;">date_str</span> = datetime.fromtimestamp<span style="color: #8c8c8c;">(</span>timestamp<span style="color: #8c8c8c;">)</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">summary_filename</span>: <span style="color: #79C0FF;">str</span> = f<span style="color: #a7bca4;">"</span>{date_str}<span style="color: #a7bca4;">-</span>{slugify(title)}<span style="color: #a7bca4;">.md"</span>
    <span style="color: #FF7B72;">if</span> year <span style="color: #FF7B72;">is</span> <span style="font-style: italic;">None</span>:
        <span style="color: #FFA657;">year</span> = CURRENT_YEAR
    <span style="color: #FF7B72;">if</span> month <span style="color: #FF7B72;">is</span> <span style="font-style: italic;">None</span>:
        <span style="color: #FFA657;">month</span> = CURRENT_MONTH
    <span style="color: #FF7B72;">if</span> in_readme_md:
        <span style="color: #FFA657;">root</span>: Path = Path<span style="color: #8c8c8c;">(</span>year, month<span style="color: #8c8c8c;">)</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#36335;&#24452;&#20026; year/month</span>
    <span style="color: #FF7B72;">else</span>:
        <span style="color: #FFA657;">root</span>: Path = Path<span style="color: #8c8c8c;">(</span>BOOKMARK_SUMMARY_REPO_NAME, year, month<span style="color: #8c8c8c;">)</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#36335;&#24452;&#20026; year/month</span>
    <span style="color: #FF7B72;">return</span> Path<span style="color: #8c8c8c;">(</span>root, summary_filename<span style="color: #8c8c8c;">)</span>


<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_text_content_path</span><span style="color: #8c8c8c;">(</span>title: <span style="color: #79C0FF;">str</span>, in_summary_md: <span style="color: #79C0FF;">bool</span> = <span style="font-style: italic;">False</span><span style="color: #8c8c8c;">)</span> -&gt; Path:
    <span style="color: #FFA657;">text_content_filename</span>: <span style="color: #79C0FF;">str</span> = f<span style="color: #a7bca4;">"</span>{CURRENT_DATE}<span style="color: #a7bca4;">-</span>{slugify(title)}<span style="color: #a7bca4;">_raw.md"</span>
    <span style="color: #FFA657;">root</span>: Path = Path<span style="color: #8c8c8c;">(</span>BOOKMARK_SUMMARY_REPO_NAME, CURRENT_YEAR, CURRENT_MONTH<span style="color: #8c8c8c;">)</span>  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#36335;&#24452;&#20026; YEAR/MONTH</span>
    <span style="color: #FF7B72;">if</span> in_summary_md:
        <span style="color: #FFA657;">root</span> = Path<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"."</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">return</span> Path<span style="color: #8c8c8c;">(</span>root, text_content_filename<span style="color: #8c8c8c;">)</span>


<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">build_summary_file</span><span style="color: #8c8c8c;">(</span>title: <span style="color: #79C0FF;">str</span>, url: <span style="color: #79C0FF;">str</span>, summary: <span style="color: #79C0FF;">str</span>, one_sentence: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #787878; font-style: italic;">"""&#26500;&#24314;&#24635;&#32467;&#25991;&#20214;&#30340;&#20869;&#23481;&#12290;"""</span>
    <span style="color: #FF7B72;">return</span> f<span style="color: #a7bca4;">"""# </span>{title}
<span style="color: #a7bca4;">- URL: </span>{url}
<span style="color: #a7bca4;">- Added At: </span>{CURRENT_DATE_AND_TIME}
<span style="color: #a7bca4;">- [Link To Text](</span>{get_text_content_path(<span style="color: #FFA657;">title</span>, <span style="color: #FFA657;">in_summary_md</span>=<span style="font-style: italic;">True</span>)}<span style="color: #a7bca4;">)</span>

<span style="color: #a7bca4;">## Summary</span>
{summary}
<span style="color: #a7bca4;">"""</span>


<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">build_index_md</span><span style="color: #8c8c8c;">(</span>title: <span style="color: #79C0FF;">str</span>, url: <span style="color: #79C0FF;">str</span>, summary: <span style="color: #79C0FF;">str</span>, one_sentence: <span style="color: #79C0FF;">str</span>, text_content: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #787878; font-style: italic;">"""&#26500;&#24314; index.md &#25991;&#20214;&#20869;&#23481;&#65292;&#28155;&#21152; YAML &#22836;&#37096;&#24182;&#21253;&#21547;&#20840;&#25991;&#20869;&#23481;&#12290;"""</span>
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22788;&#29702;&#26631;&#39064;&#20013;&#30340;&#20882;&#21495;</span>
    <span style="color: #FFA657;">yaml_safe_title</span> = title.replace<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">':'</span>, <span style="color: #a7bca4;">'-'</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #FF7B72;">return</span> f<span style="color: #a7bca4;">"""---</span>
<span style="color: #a7bca4;">title: </span>{yaml_safe_title}
<span style="color: #a7bca4;">date: </span>{CURRENT_DATE}
<span style="color: #a7bca4;">extra:</span>
<span style="color: #a7bca4;">  source: </span>{url}
<span style="color: #a7bca4;">  original_title: </span>{title}
<span style="color: #a7bca4;">---</span>
<span style="color: #a7bca4;">## Summary</span>
{summary}
<span style="color: #a7bca4;">## Full Content</span>
{text_content}
<span style="color: #a7bca4;">"""</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">build_summary_readme_md</span><span style="color: #8c8c8c;">(</span>summarized_bookmarks: List<span style="color: #93a8c6;">[</span>SummarizedBookmark<span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
    <span style="color: #FFA657;">initial_prefix</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">"""# Clip</span>
<span style="color: #a7bca4;">&#24635;&#20250;&#26377;&#19968;&#20123;&#27809;&#36798;&#21040;&#25105;&#24819;&#25910;&#24405;&#21040;PKM&#20307;&#31995;&#37324;&#26631;&#20934;&#30340;&#25991;&#31456;&#65292;&#20294;&#21448;&#24323;&#20043;&#21487;&#24796;&#12290;&#20171;&#20110;&#36825;&#20004;&#32773;&#20043;&#38388;&#30340;&#65292;&#23601;&#25918;&#22312;&#36825;&#20010;clip&#37324;&#20102;&#12290;&#21306;&#21035;&#20110;&#31508;&#35760;&#65292;&#36825;&#37324;&#20027;&#35201;&#26159;&#21407;&#25991;&#30340; Markdown&#12290;</span>

<span style="color: #a7bca4;">Inspired by :[Owen's Clip](https://github.com/theowenyoung/clip) , [LLM x &#20070;&#31614;&#25910;&#34255;&#65306;&#25688;&#35201; &amp; &#20840;&#25991;&#32034;&#24341; - Nekonull's Garden](https://nekonull.me/posts/llm_x_bookmark/)</span>

<span style="color: #a7bca4;">## Summarized Bookmarks</span>
<span style="color: #a7bca4;">"""</span>
    <span style="color: #FFA657;">summary_list</span>: <span style="color: #79C0FF;">str</span> = <span style="color: #a7bca4;">""</span>
    <span style="color: #FFA657;">sorted_summarized_bookmarks</span> = <span style="color: #79C0FF;">sorted</span><span style="color: #8c8c8c;">(</span>summarized_bookmarks, key=<span style="color: #FF7B72;">lambda</span> bookmark: bookmark.timestamp, reverse=<span style="font-style: italic;">True</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">for</span> bookmark <span style="color: #FF7B72;">in</span> sorted_summarized_bookmarks:
        <span style="color: #FFA657;">summary_file_path</span> = get_summary_file_path<span style="color: #8c8c8c;">(</span>
            title=bookmark.title,
            timestamp=bookmark.timestamp,
            month=bookmark.month,
            in_readme_md=<span style="font-style: italic;">True</span>
        <span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">summary_list</span> += f<span style="color: #a7bca4;">"- (</span>{datetime.fromtimestamp(bookmark.timestamp).strftime('%Y-%m-%d')}<span style="color: #a7bca4;">) [</span>{bookmark.title}<span style="color: #a7bca4;">](</span>{summary_file_path}<span style="color: #a7bca4;">)</span><span style="font-style: italic;">\n</span><span style="color: #a7bca4;">"</span>
    <span style="color: #FF7B72;">return</span> initial_prefix + summary_list

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">post_to_teable</span><span style="color: #8c8c8c;">(</span>title: <span style="color: #79C0FF;">str</span>, url: <span style="color: #79C0FF;">str</span>, one_sentence: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="font-style: italic;">None</span>:
    <span style="color: #787878; font-style: italic;">"""</span>
<span style="color: #787878; font-style: italic;">    Post a bookmark record to Teable</span>
<span style="color: #787878; font-style: italic;">    """</span>
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">conn</span> = http.client.HTTPSConnection<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"app.teable.io"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #FFA657;">payload</span> = <span style="color: #8c8c8c;">{</span>
            <span style="color: #a7bca4;">"typecast"</span>: <span style="font-style: italic;">True</span>,
            <span style="color: #a7bca4;">"records"</span>: <span style="color: #93a8c6;">[</span><span style="color: #b0b1a3;">{</span>
                <span style="color: #a7bca4;">"fields"</span>: <span style="color: #97b098;">{</span>
                    <span style="color: #a7bca4;">"Title"</span>: title,
                    <span style="color: #a7bca4;">"Source"</span>: url,
                    <span style="color: #a7bca4;">"Summary"</span>: one_sentence,
                <span style="color: #97b098;">}</span>
            <span style="color: #b0b1a3;">}</span><span style="color: #93a8c6;">]</span>
        <span style="color: #8c8c8c;">}</span>

        <span style="color: #FFA657;">headers</span> = <span style="color: #8c8c8c;">{</span>
            <span style="color: #a7bca4;">'Authorization'</span>: f<span style="color: #a7bca4;">"Bearer </span>{TEABLE_TOKEN}<span style="color: #a7bca4;">"</span>,
            <span style="color: #a7bca4;">'Content-Type'</span>: <span style="color: #a7bca4;">"application/json"</span>
        <span style="color: #8c8c8c;">}</span>

        conn.request<span style="color: #8c8c8c;">(</span>
            <span style="color: #a7bca4;">"POST"</span>,
            f<span style="color: #a7bca4;">"/api/table/</span>{TEABLE_TABLE_ID}<span style="color: #a7bca4;">/record"</span>,
            json.dumps<span style="color: #93a8c6;">(</span>payload<span style="color: #93a8c6;">)</span>,
            headers
        <span style="color: #8c8c8c;">)</span>

        <span style="color: #FFA657;">response</span> = conn.getresponse<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">if</span> response.status <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">in</span> <span style="color: #8c8c8c;">(</span>200, 201<span style="color: #8c8c8c;">)</span>:
            logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Failed to post to Teable. Status: </span>{response.status}<span style="color: #a7bca4;">, Response: </span>{response.read().decode()}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">else</span>:
            logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Successfully posted to Teable"</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error posting to Teable: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">finally</span>:
        conn.close<span style="color: #8c8c8c;">()</span>

<span style="color: #FF7B72; font-style: italic;">@log_execution_time</span>
<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">process_bookmark_file</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#35835;&#21462;&#20070;&#31614;&#21644;&#24050;&#24635;&#32467;&#20070;&#31614;</span>
    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_COLLECTION_REPO_NAME}<span style="color: #a7bca4;">/README.md'</span>, <span style="color: #a7bca4;">'r'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        <span style="color: #FFA657;">bookmark_lines</span> = f.readlines<span style="color: #8c8c8c;">()</span>

    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_SUMMARY_REPO_NAME}<span style="color: #a7bca4;">/data.json'</span>, <span style="color: #a7bca4;">'r'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        <span style="color: #FFA657;">summarized_bookmark_dicts</span> = json.load<span style="color: #8c8c8c;">(</span>f<span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">summarized_bookmarks</span> = <span style="color: #8c8c8c;">[</span>SummarizedBookmark<span style="color: #93a8c6;">(</span>**bookmark<span style="color: #93a8c6;">)</span> <span style="color: #FF7B72;">for</span> bookmark <span style="color: #FF7B72;">in</span> summarized_bookmark_dicts<span style="color: #8c8c8c;">]</span>

    <span style="color: #FFA657;">summarized_urls</span> = <span style="color: #8c8c8c;">{</span>bookmark.url <span style="color: #FF7B72;">for</span> bookmark <span style="color: #FF7B72;">in</span> summarized_bookmarks<span style="color: #8c8c8c;">}</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#25214;&#21040;&#26410;&#24635;&#32467;&#30340;&#20070;&#31614;</span>
    <span style="color: #FFA657;">title</span>, <span style="color: #FFA657;">url</span> = <span style="font-style: italic;">None</span>, <span style="font-style: italic;">None</span>
    <span style="color: #FF7B72;">for</span> line <span style="color: #FF7B72;">in</span> bookmark_lines:
        <span style="color: #FF7B72;">match</span> = re.search<span style="color: #8c8c8c;">(</span>r<span style="color: #a7bca4;">'- \[(.*?)\]\((.*?)\)'</span>, line<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">match</span> <span style="color: #FF7B72;">and</span> <span style="color: #FF7B72;">match</span>.group<span style="color: #8c8c8c;">(</span>2<span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">in</span> summarized_urls:
            <span style="color: #FFA657;">title</span>, <span style="color: #FFA657;">url</span> = <span style="color: #FF7B72;">match</span>.groups<span style="color: #8c8c8c;">()</span>
            <span style="color: #FF7B72;">break</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22914;&#26524;&#27809;&#26377;&#25214;&#21040;&#26032;&#30340;&#20070;&#31614;&#65292;&#21017;&#36864;&#20986;</span>
    <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> title <span style="color: #FF7B72;">or</span> <span style="color: #FF7B72;">not</span> url:
        logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"No new bookmarks to summarize."</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">return</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#23558;&#26631;&#39064;&#26684;&#24335;&#21270;&#20026;&#25991;&#20214;&#21517;</span>
    <span style="color: #FFA657;">title_slug</span> = slugify<span style="color: #8c8c8c;">(</span>title<span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21019;&#24314; YEAR/MONTH/ &#30446;&#24405;</span>
    <span style="color: #FFA657;">monthly_path</span> = Path<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_SUMMARY_REPO_NAME}<span style="color: #a7bca4;">/</span>{CURRENT_YEAR}<span style="color: #a7bca4;">/</span>{CURRENT_MONTH}<span style="color: #a7bca4;">'</span><span style="color: #8c8c8c;">)</span>
    monthly_path.mkdir<span style="color: #8c8c8c;">(</span>parents=<span style="font-style: italic;">True</span>, exist_ok=<span style="font-style: italic;">True</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21019;&#24314; content/YEAR/MONTH/TITLE/ &#30446;&#24405;</span>
    <span style="color: #FFA657;">content_path</span> = Path<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_SUMMARY_REPO_NAME}<span style="color: #a7bca4;">/content/</span>{CURRENT_YEAR}<span style="color: #a7bca4;">/</span>{CURRENT_MONTH}<span style="color: #a7bca4;">/</span>{title_slug}<span style="color: #a7bca4;">'</span><span style="color: #8c8c8c;">)</span>
    content_path.mkdir<span style="color: #8c8c8c;">(</span>parents=<span style="font-style: italic;">True</span>, exist_ok=<span style="font-style: italic;">True</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#33719;&#21462;&#21644;&#24635;&#32467;&#20869;&#23481;</span>
    <span style="color: #FFA657;">text_content</span> = get_text_content<span style="color: #8c8c8c;">(</span>url<span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">summary</span> = summarize_text<span style="color: #8c8c8c;">(</span>text_content<span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">one_sentence</span> = one_sentence_summary<span style="color: #8c8c8c;">(</span>summary<span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">timestamp</span> = <span style="color: #79C0FF;">int</span><span style="color: #8c8c8c;">(</span>datetime.now<span style="color: #93a8c6;">()</span>.timestamp<span style="color: #93a8c6;">()</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20351;&#29992;&#24403;&#21069;&#26085;&#26399;&#21019;&#24314;&#21069;&#32512;</span>
    <span style="color: #FFA657;">date_prefix</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y-%m-%d-'</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20445;&#23384;&#21407;&#22987;&#20869;&#23481;&#21040; YEAR/MONTH/yyyy-MM-dd-title_raw.md</span>
    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>monthly_path / f<span style="color: #a7bca4;">"</span>{date_prefix}{title_slug}<span style="color: #a7bca4;">_raw.md"</span>, <span style="color: #a7bca4;">'w'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        f.write<span style="color: #8c8c8c;">(</span>text_content<span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20445;&#23384;&#24635;&#32467;&#20869;&#23481;&#21040; YEAR/MONTH/yyyy-MM-dd-title.md</span>
    <span style="color: #FFA657;">summary_content</span> = build_summary_file<span style="color: #8c8c8c;">(</span>title, url, summary, one_sentence<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>monthly_path / f<span style="color: #a7bca4;">"</span>{date_prefix}{title_slug}<span style="color: #a7bca4;">.md"</span>, <span style="color: #a7bca4;">'w'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        f.write<span style="color: #8c8c8c;">(</span>summary_content<span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20445;&#23384; index.md &#21040; content/YEAR/MONTH/TITLE/index.md</span>
    <span style="color: #FFA657;">index_content</span> = build_index_md<span style="color: #8c8c8c;">(</span>title, url, summary, one_sentence, text_content<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>content_path / <span style="color: #a7bca4;">"index.md"</span>, <span style="color: #a7bca4;">'w'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        f.write<span style="color: #8c8c8c;">(</span>index_content<span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#24050;&#24635;&#32467;&#30340;&#20070;&#31614;&#25968;&#25454;</span>
    summarized_bookmarks.append<span style="color: #8c8c8c;">(</span>SummarizedBookmark<span style="color: #93a8c6;">(</span>
        title=title,
        url=url,
        summary=one_sentence,
        year=CURRENT_YEAR,
        month=CURRENT_MONTH,
        timestamp=timestamp
    <span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032; README &#21644; data.json</span>
    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_SUMMARY_REPO_NAME}<span style="color: #a7bca4;">/Bookmarks_List.md'</span>, <span style="color: #a7bca4;">'w'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        f.write<span style="color: #8c8c8c;">(</span>build_summary_readme_md<span style="color: #93a8c6;">(</span>summarized_bookmarks<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #FF7B72;">with</span> <span style="color: #79C0FF;">open</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">'</span>{BOOKMARK_SUMMARY_REPO_NAME}<span style="color: #a7bca4;">/data.json'</span>, <span style="color: #a7bca4;">'w'</span>, encoding=<span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">as</span> f:
        json.dump<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">[</span>asdict<span style="color: #b0b1a3;">(</span>bookmark<span style="color: #b0b1a3;">)</span> <span style="color: #FF7B72;">for</span> bookmark <span style="color: #FF7B72;">in</span> summarized_bookmarks<span style="color: #93a8c6;">]</span>, f, indent=2, ensure_ascii=<span style="font-style: italic;">False</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Post to Teable</span>
    <span style="color: #FF7B72;">if</span> TEABLE_TOKEN <span style="color: #FF7B72;">and</span> TEABLE_TABLE_ID:
        post_to_teable<span style="color: #8c8c8c;">(</span>title, url, one_sentence<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">else</span>:
        logging.warning<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Teable API token or table ID not set, skipping Teable update"</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">main</span><span style="color: #8c8c8c;">()</span>:
    process_bookmark_file<span style="color: #8c8c8c;">()</span>

<span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #a7bca4;">"__main__"</span>:
    main<span style="color: #8c8c8c;">()</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org70e9579" class="outline-3">
<h3 id="org70e9579">workflow</h3>
<div class="outline-text-3" id="text-org70e9579">
<p>
修改 bookmark-collection 仓库的 yaml：
</p>

<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #FFA657;">name</span>: Bookmark Summary

<span style="font-style: italic;">on</span>:
  <span style="color: #FFA657;">workflow_dispatch</span>:  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21482;&#20445;&#30041;&#25163;&#21160;&#35302;&#21457;&#21644;&#34987;&#20854;&#20182; workflow &#35302;&#21457;&#30340;&#24773;&#20917;</span>
<span style="color: #FFA657;">concurrency</span>:
  <span style="color: #FFA657;">group</span>: mygroup
  <span style="color: #FFA657;">cancel-in-progress</span>: <span style="font-style: italic;">false</span>

<span style="color: #FFA657;">jobs</span>:
  <span style="color: #FFA657;">summarize</span>:
    <span style="color: #FFA657;">runs-on</span>: ubuntu-latest
    <span style="color: #FFA657;">steps</span>:
      - <span style="color: #FFA657;">name</span>: Checkout bookmark-collection
        <span style="color: #FFA657;">uses</span>: actions/checkout@v2
        <span style="color: #FFA657;">with</span>:
          <span style="color: #FFA657;">path</span>: bookmark-collection

      - <span style="color: #FFA657;">name</span>: Checkout bookmark-summary
        <span style="color: #FFA657;">uses</span>: actions/checkout@v2
        <span style="color: #FFA657;">with</span>:
          <span style="color: #FFA657;">repository</span>: VandeeFeng/bookmark-summary
          <span style="color: #FFA657;">path</span>: bookmark-summary
          <span style="color: #FFA657;">token</span>: ${{ secrets.PAT }}

      - <span style="color: #FFA657;">name</span>: Set up Python
        <span style="color: #FFA657;">uses</span>: actions/setup-python@v2
        <span style="color: #FFA657;">with</span>:
          <span style="color: #FFA657;">python-version</span>: <span style="color: #a7bca4;">'3.x'</span>

      - <span style="color: #FFA657;">name</span>: Install dependencies with retry
        <span style="color: #FFA657;">uses</span>: nick-fields/retry@v3  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20351;&#29992; retry &#21253;&#35013;&#23433;&#35013;&#20381;&#36182;&#27493;&#39588;</span>
        <span style="color: #FFA657;">with</span>:
          <span style="color: #FFA657;">timeout_minutes</span>: 2  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#27599;&#27425;&#23581;&#35797;&#30340;&#36229;&#26102;&#26102;&#38388;&#65288;2&#20998;&#38047;&#65289;</span>
          <span style="color: #FFA657;">max_attempts</span>: 3  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26368;&#22823;&#37325;&#35797;&#27425;&#25968;</span>
          <span style="color: #FFA657;">command</span>: |
            <span style="color: #a7bca4;">python -m pip install --upgrade pip</span>
<span style="color: #a7bca4;">            pip install requests waybackpy</span>

      - <span style="color: #FFA657;">name</span>: Process changes with retry
        <span style="color: #FFA657;">uses</span>: nick-fields/retry@v3  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21253;&#35013;&#21464;&#26356;&#22788;&#29702;&#27493;&#39588;</span>
        <span style="color: #FFA657;">with</span>:
          <span style="color: #FFA657;">timeout_minutes</span>: 2  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#27599;&#27425;&#23581;&#35797;&#30340;&#36229;&#26102;&#26102;&#38388;&#65288;5&#20998;&#38047;&#65289;</span>
          <span style="color: #FFA657;">max_attempts</span>: 3  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26368;&#22823;&#37325;&#35797;&#27425;&#25968;</span>
          <span style="color: #FFA657;">command</span>: |
            <span style="color: #a7bca4;">OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \</span>
<span style="color: #a7bca4;">            OPENAI_API_MODEL=${{ secrets.OPENAI_API_MODEL }} \</span>
<span style="color: #a7bca4;">            OPENAI_API_ENDPOINT=${{ secrets.OPENAI_API_ENDPOINT }} \</span>
<span style="color: #a7bca4;">            TEABLE_TABLE_ID=${{ secrets.TEABLE_TABLE_ID }} \</span>
<span style="color: #a7bca4;">            TEABLE_TOKEN=${{ secrets.TEABLE_TOKEN }} \</span>
<span style="color: #a7bca4;">            python bookmark-summary/process_changes.py</span>

      - <span style="color: #FFA657;">name</span>: Commit changes to bookmark-summary
        <span style="color: #FFA657;">run</span>: |
          <span style="color: #a7bca4;">cd bookmark-summary</span>
          git config --local user.email <span style="color: #a7bca4;">"action@github.com"</span>
          git config --local user.name <span style="color: #a7bca4;">"GitHub Action"</span>
<span style="color: #a7bca4;">          git add .</span>
          git commit -m <span style="color: #a7bca4;">"Add new summaries"</span> || echo <span style="color: #a7bca4;">"No changes to commit"</span>
<span style="color: #a7bca4;">          git push</span>

</pre>
</div>
</div>
</div>
<div id="outline-container-org44da16c" class="outline-3">
<h3 id="org44da16c">bash</h3>
<div class="outline-text-3" id="text-org44da16c">
<p>
顺便把 websites 也用 bash 脚本保存在 teable 里了，之前一直用 org-capture，现在太多了不好检索。让 Claude 把之前的列表转换为了 csv 导入到了 teable。
</p>

<div class="org-src-container">
<pre class="src src-bash">
<span style="color: #787878; font-style: italic;">#</span><span style="color: #787878; font-style: italic;">!/bin/bash</span>

<span style="color: #FF7B72;">while</span> true; <span style="color: #FF7B72;">do</span>
  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#25552;&#31034;&#29992;&#25143;&#36755;&#20837;&#20449;&#24687;</span>
  <span style="color: #79C0FF;">read</span> -p <span style="color: #a7bca4;">"Enter Name (or type 'q' to quit): "</span> name
  <span style="color: #FF7B72;">if</span> <span style="color: #8c8c8c;">[</span><span style="color: #93a8c6;">[</span> <span style="color: #a7bca4;">"$name"</span> == <span style="color: #a7bca4;">"q"</span> <span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">]</span>; <span style="color: #FF7B72;">then</span>
    <span style="color: #79C0FF;">echo</span> <span style="color: #a7bca4;">"Exiting..."</span>
    <span style="color: #FF7B72;">break</span>
  <span style="color: #FF7B72;">fi</span>

  <span style="color: #79C0FF;">read</span> -p <span style="color: #a7bca4;">"Enter Intro (or type 'q' to quit): "</span> intro
  <span style="color: #FF7B72;">if</span> <span style="color: #8c8c8c;">[</span><span style="color: #93a8c6;">[</span> <span style="color: #a7bca4;">"$intro"</span> == <span style="color: #a7bca4;">"q"</span> <span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">]</span>; <span style="color: #FF7B72;">then</span>
    <span style="color: #79C0FF;">echo</span> <span style="color: #a7bca4;">"Exiting..."</span>
    <span style="color: #FF7B72;">break</span>
  <span style="color: #FF7B72;">fi</span>

  <span style="color: #79C0FF;">read</span> -p <span style="color: #a7bca4;">"Enter Source (or type 'q' to quit): "</span> source
  <span style="color: #FF7B72;">if</span> <span style="color: #8c8c8c;">[</span><span style="color: #93a8c6;">[</span> <span style="color: #a7bca4;">"$source"</span> == <span style="color: #a7bca4;">"q"</span> <span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">]</span>; <span style="color: #FF7B72;">then</span>
    <span style="color: #79C0FF;">echo</span> <span style="color: #a7bca4;">"Exiting..."</span>
    <span style="color: #FF7B72;">break</span>
  <span style="color: #FF7B72;">fi</span>
<span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21457;&#36865; POST &#35831;&#27714;</span>
curl --request POST <span style="color: #a7bca4;">\</span>
  --url https://app.teable.io/api/table/TEABLE_ID/record <span style="color: #a7bca4;">\</span>
  --header <span style="color: #a7bca4;">'Authorization: Bearer TEABLE_TOKEN'</span> <span style="color: #a7bca4;">\</span>
  --header <span style="color: #a7bca4;">'content-type: application/json'</span> <span style="color: #a7bca4;">\</span>
  --data <span style="color: #a7bca4;">"$(</span><span style="color: #fa8072;">cat &lt;&lt;EOF</span>
<span style="color: #a7bca4;">{</span>
<span style="color: #a7bca4;">  "typecast": true,</span>
<span style="color: #a7bca4;">  "records": [{</span>
<span style="color: #a7bca4;">    "fields": {</span>
<span style="color: #a7bca4;">      "Name": "$name",</span>
<span style="color: #a7bca4;">      "Intro": "$intro",</span>
<span style="color: #a7bca4;">      "Source": "$source"</span>
<span style="color: #a7bca4;">    }</span>
<span style="color: #a7bca4;">  }]</span>
<span style="color: #a7bca4;">}</span>
<span style="color: #a7bca4;">EOF</span>
<span style="color: #a7bca4;">)"</span>


<span style="color: #79C0FF;">echo</span> <span style="color: #a7bca4;">"$name $source &#20869;&#23481;&#24050;&#25104;&#21151;&#20889;&#20837; table websites"</span>
<span style="color: #FF7B72;">done</span>

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org15c9ac8" class="outline-2">
<h2 id="org15c9ac8">PocketBase</h2>
<div class="outline-text-2" id="text-org15c9ac8">
<p>
需要在仓库的 secret 里增加 <code>POCKETBASE_TOKEN</code> 、 <code>POCKETBASE_API</code> 两个secert，填入自己的 pocketbase API 地址和请求头。
</p>

<p>
这个请求头我也是看了好半天文档才弄明白：
</p>

<p>
需要在指定的 collection 的 API Rules 里，手动加上 <code>@request.headers.x_token = "Your_token"</code> ,这里填入的内容就是 <code>POCKETBASE_TOKEN</code> ， <code>POCKETBASE_API</code> 在每个 collection 里会显示。
</p>

<p>
由于这里指定了 header，在 python 的部分就得特别处理：
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="color: #FFA657;">second_response</span> = requests.post<span style="color: #8c8c8c;">(</span>
    url=os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'POCKETBASE_API'</span><span style="color: #93a8c6;">]</span>,
    headers=<span style="color: #93a8c6;">{</span>
        <span style="color: #a7bca4;">"x_token"</span>: f<span style="color: #a7bca4;">"</span>{os.environ['POCKETBASE_TOKEN']}<span style="color: #a7bca4;">"</span>,
        <span style="color: #a7bca4;">"Content-Type"</span>: <span style="color: #a7bca4;">"application/json"</span>
    <span style="color: #93a8c6;">}</span>,
    json=<span style="color: #93a8c6;">{</span>
        <span style="color: #a7bca4;">"URL"</span>: url,
        <span style="color: #a7bca4;">"title"</span>: title
    <span style="color: #93a8c6;">}</span>
<span style="color: #8c8c8c;">)</span>

</pre>
</div>
</div>

<div id="outline-container-orgcb0350f" class="outline-3">
<h3 id="orgcb0350f">docker 部署到 VPS</h3>
<div class="outline-text-3" id="text-orgcb0350f">
<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #FFA657;">version</span>: <span style="color: #a7bca4;">"3.7"</span>
<span style="color: #FFA657;">services</span>:
  <span style="color: #FFA657;">pocketbase</span>:
    <span style="color: #FFA657;">image</span>: ghcr.io/muchobien/pocketbase:latest
    <span style="color: #FFA657;">container_name</span>: pocketbase
    <span style="color: #FFA657;">restart</span>: unless-stopped
    <span style="color: #FFA657;">ports</span>:
      - <span style="color: #a7bca4;">"8090:8090"</span>
    <span style="color: #FFA657;">volumes</span>:
      - <span style="color: #a7bca4;">"./data:/pb_data"</span>
    <span style="color: #FFA657;">healthcheck</span>: <span style="color: #787878; font-style: italic;">#</span><span style="color: #787878; font-style: italic;">optional (recommended) since v0.10.0</span>
      <span style="color: #FFA657;">test</span>: wget --no-verbose --tries=1 --spider http://localhost:8090/api/health || exit 1
      <span style="color: #FFA657;">interval</span>: 5s
      <span style="color: #FFA657;">timeout</span>: 5s
      <span style="color: #FFA657;">retries</span>: 5

</pre>
</div>
</div>
</div>
<div id="outline-container-org0078a11" class="outline-3">
<h3 id="org0078a11">Python</h3>
<div class="outline-text-3" id="text-org0078a11">
<p>
修改 bookmark-collection 仓库的 py 脚本：
</p>

<div class="org-src-container">
<pre class="src src-python">
<span style="color: #FF7B72;">import</span> os
<span style="color: #FF7B72;">import</span> re
<span style="color: #FF7B72;">import</span> logging
<span style="color: #FF7B72;">import</span> requests
<span style="color: #FF7B72;">from</span> github <span style="color: #FF7B72;">import</span> Github

logging.basicConfig<span style="color: #8c8c8c;">(</span>
    level=logging.INFO,
    <span style="color: #79C0FF;">format</span>=<span style="color: #a7bca4;">'%(asctime)s - %(message)s'</span>,
    datefmt=<span style="color: #a7bca4;">'%Y-%m-%d %H:%M:%S'</span>
<span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_added_content</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;">"""&#33719;&#21462;&#36825;&#27425;&#25552;&#20132;&#26032;&#22686;&#30340;&#20869;&#23481;"""</span>
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">commit_sha</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'GITHUB_SHA'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">commit</span> = repo.get_commit<span style="color: #8c8c8c;">(</span>commit_sha<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">for</span> <span style="color: #79C0FF;">file</span> <span style="color: #FF7B72;">in</span> commit.files:
            <span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">file</span>.filename.endswith<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'.md'</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">file</span>.patch <span style="color: #FF7B72;">and</span> <span style="color: #a7bca4;">'+'</span> <span style="color: #FF7B72;">in</span> <span style="color: #79C0FF;">file</span>.patch:
                    <span style="color: #FFA657;">added_lines</span> = <span style="color: #8c8c8c;">[</span>line<span style="color: #93a8c6;">[</span>1:<span style="color: #93a8c6;">]</span> <span style="color: #FF7B72;">for</span> line <span style="color: #FF7B72;">in</span> <span style="color: #79C0FF;">file</span>.patch.split<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'</span><span style="font-style: italic;">\n</span><span style="color: #a7bca4;">'</span><span style="color: #93a8c6;">)</span>
                                 <span style="color: #FF7B72;">if</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'+'</span><span style="color: #93a8c6;">)</span> <span style="color: #FF7B72;">and</span> <span style="color: #FF7B72;">not</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'+++'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
                    <span style="color: #FF7B72;">return</span> added_lines
        <span style="color: #FF7B72;">return</span> <span style="color: #8c8c8c;">[]</span>
    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error getting commit content: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">extract_url_and_title</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span>:
    <span style="color: #787878; font-style: italic;">"""&#20174;&#34892;&#20013;&#25552;&#21462;URL&#21644;&#26631;&#39064;&#65292;&#25903;&#25345;markdown&#26684;&#24335;&#30340;&#38142;&#25509; [title](url)"""</span>
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26356;&#26032;&#21518;&#30340;&#25552;&#21462;&#27169;&#24335;&#65292;&#21516;&#26102;&#33719;&#21462;&#26631;&#39064;&#21644;URL</span>
    <span style="color: #FFA657;">pattern</span> = r<span style="color: #a7bca4;">'\[(.*?)\]\((https?://[\w\-._~:/?#\[\]@!$&amp;\'()*+,;=.%]+)\)'</span>
    <span style="color: #FF7B72;">match</span> = re.search<span style="color: #8c8c8c;">(</span>pattern, line<span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">match</span>:
        <span style="color: #FFA657;">title</span> = <span style="color: #FF7B72;">match</span>.group<span style="color: #8c8c8c;">(</span>1<span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">url</span> = <span style="color: #FF7B72;">match</span>.group<span style="color: #8c8c8c;">(</span>2<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">return</span> url, title
    <span style="color: #FF7B72;">return</span> <span style="font-style: italic;">None</span>, <span style="font-style: italic;">None</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">has_clip_tag</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">bool</span>:
    <span style="color: #787878; font-style: italic;">"""&#26816;&#26597;&#26159;&#21542;&#21253;&#21547; #2clip &#26631;&#31614;"""</span>
    <span style="color: #FF7B72;">return</span> <span style="color: #79C0FF;">bool</span><span style="color: #8c8c8c;">(</span>re.search<span style="color: #93a8c6;">(</span>r<span style="color: #a7bca4;">'#2clip\b'</span>, line<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">trigger_workflow</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;">"""&#35302;&#21457;&#21478;&#19968;&#20010;workflow"""</span>
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">workflow</span> = repo.get_workflow<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"bookmark_summary.yml"</span><span style="color: #8c8c8c;">)</span>
        workflow.create_dispatch<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"main"</span><span style="color: #8c8c8c;">)</span>
        logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Successfully triggered the bookmark_summary workflow"</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Failed to trigger workflow: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">main</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #FF7B72;">try</span>:
        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#33719;&#21462;&#25152;&#26377;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #FFA657;">added_lines</span> = get_added_content<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> added_lines:
            logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"No new markdown content found in this commit"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">return</span>

        <span style="color: #FFA657;">trigger_needed</span> = <span style="font-style: italic;">False</span>
        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22788;&#29702;&#27599;&#19968;&#34892;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #FF7B72;">for</span> line <span style="color: #FF7B72;">in</span> added_lines:
            <span style="color: #FFA657;">line</span> = line.strip<span style="color: #8c8c8c;">()</span>
            logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Processing line: </span>{line}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#26816;&#26597;&#26631;&#31614;</span>
            <span style="color: #FF7B72;">if</span> has_clip_tag<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>:
                <span style="color: #FFA657;">trigger_needed</span> = <span style="font-style: italic;">True</span>
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Found #2clip tag"</span><span style="color: #8c8c8c;">)</span>

            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#25552;&#21462;&#24182;&#22788;&#29702;URL&#21644;&#26631;&#39064;&#65288;&#26080;&#35770;&#26159;&#21542;&#26377;&#26631;&#31614;&#65289;</span>
            <span style="color: #FFA657;">url</span>, <span style="color: #FFA657;">title</span> = extract_url_and_title<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">if</span> url:
                <span style="color: #FF7B72;">try</span>:
                    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21457;&#36865;&#21040; Readwise</span>
                    <span style="color: #FFA657;">response</span> = requests.post<span style="color: #8c8c8c;">(</span>
                        url=<span style="color: #a7bca4;">"https://readwise.io/api/v3/save/"</span>,
                        headers=<span style="color: #93a8c6;">{</span><span style="color: #a7bca4;">"Authorization"</span>: f<span style="color: #a7bca4;">"Token </span>{os.environ['READWISE_TOKEN']}<span style="color: #a7bca4;">"</span><span style="color: #93a8c6;">}</span>,
                        json=<span style="color: #93a8c6;">{</span>
                            <span style="color: #a7bca4;">"url"</span>: url,
                            <span style="color: #a7bca4;">"tags"</span>: <span style="color: #b0b1a3;">[</span><span style="color: #a7bca4;">"Bookmark"</span><span style="color: #b0b1a3;">]</span>
                        <span style="color: #93a8c6;">}</span>
                    <span style="color: #8c8c8c;">)</span>
                    response.raise_for_status<span style="color: #8c8c8c;">()</span>
                    logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Successfully saved URL to Readwise: </span>{url}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

                    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21457;&#36865;&#21040;&#31532;&#20108;&#20010; API endpoint</span>
                    <span style="color: #FFA657;">second_response</span> = requests.post<span style="color: #8c8c8c;">(</span>
                        url=os.environ<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'POCKETBASE_API'</span><span style="color: #93a8c6;">]</span>,
                        headers=<span style="color: #93a8c6;">{</span>
                            <span style="color: #a7bca4;">"x_token"</span>: f<span style="color: #a7bca4;">"</span>{os.environ['POCKETBASE_TOKEN']}<span style="color: #a7bca4;">"</span>,
                            <span style="color: #a7bca4;">"Content-Type"</span>: <span style="color: #a7bca4;">"application/json"</span>
                        <span style="color: #93a8c6;">}</span>,
                        json=<span style="color: #93a8c6;">{</span>
                            <span style="color: #a7bca4;">"URL"</span>: url,
                            <span style="color: #a7bca4;">"title"</span>: title
                        <span style="color: #93a8c6;">}</span>
                    <span style="color: #8c8c8c;">)</span>
                    second_response.raise_for_status<span style="color: #8c8c8c;">()</span>
                    logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Successfully saved URL to pocketbase: </span>{url}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #FF7B72;">except</span> requests.exceptions.RequestException <span style="color: #FF7B72;">as</span> e:
                    logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Failed to save URL </span>{url}<span style="color: #a7bca4;">: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22914;&#26524;&#21457;&#29616;&#20102;&#26631;&#31614;&#65292;&#35302;&#21457;workflow</span>
        <span style="color: #FF7B72;">if</span> trigger_needed:
            logging.info<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Triggering workflow due to #2clip tag"</span><span style="color: #8c8c8c;">)</span>
            trigger_workflow<span style="color: #8c8c8c;">()</span>

    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #a7bca4;">"__main__"</span>:
    main<span style="color: #8c8c8c;">()</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orgf84df6b" class="outline-3">
<h3 id="orgf84df6b">workflow</h3>
<div class="outline-text-3" id="text-orgf84df6b">
<p>
修改 bookmark-collection 仓库的 yaml：
</p>

<div class="org-src-container">
<pre class="src src-yaml"><span style="color: #FFA657;">name</span>: Save Bookmark to Readwise

<span style="font-style: italic;">on</span>:
  <span style="color: #FFA657;">push</span>:
    <span style="color: #FFA657;">branches</span>:
      - main
    <span style="color: #FFA657;">paths</span>:
      - <span style="color: #a7bca4;">'**.md'</span>
  <span style="color: #FFA657;">workflow_dispatch</span>:

<span style="color: #FFA657;">permissions</span>:
  <span style="color: #FFA657;">contents</span>: read
  <span style="color: #FFA657;">actions</span>: write

<span style="color: #FFA657;">jobs</span>:
  <span style="color: #FFA657;">save-to-readwise</span>:
    <span style="color: #FFA657;">runs-on</span>: ubuntu-latest

    <span style="color: #FFA657;">steps</span>:
    - <span style="color: #FFA657;">name</span>: Checkout repository
      <span style="color: #FFA657;">uses</span>: actions/checkout@v4
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">token</span>: ${{ secrets.GITHUB_TOKEN }}

    - <span style="color: #FFA657;">name</span>: Set up Python
      <span style="color: #FFA657;">uses</span>: actions/setup-python@v4
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">python-version</span>: <span style="color: #a7bca4;">'3.10'</span>

    - <span style="color: #FFA657;">name</span>: Install dependencies
      <span style="color: #FFA657;">run</span>: |
        <span style="color: #a7bca4;">python -m pip install --upgrade pip</span>
<span style="color: #a7bca4;">        pip install requests PyGithub</span>

    - <span style="color: #FFA657;">name</span>: Run bookmark saver
      <span style="color: #FFA657;">env</span>:
        <span style="color: #FFA657;">READWISE_TOKEN</span>: ${{ secrets.READWISE_TOKEN }}
        <span style="color: #FFA657;">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style="color: #FFA657;">GITHUB_REPOSITORY</span>: ${{ github.repository }}
        <span style="color: #FFA657;">POCKETBASE_API</span>: ${{ secrets.POCKETBASE_API }}
        <span style="color: #FFA657;">POCKETBASE_TOKEN</span>: ${{ secrets.POCKETBASE_TOKEN }}
      <span style="color: #FFA657;">run</span>: python save_to_readwise.py

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6b7e62c" class="outline-2">
<h2 id="org6b7e62c">Readwise highlights</h2>
<div class="outline-text-2" id="text-org6b7e62c">
<p>
写了一个 <code>class ReadwiseAPI</code> 方便其他项目引入。可以定时获取我所有 highlights 的 title 和 url。
</p>

<p>
后面可以直接把 highlights 导入到 pocketbase。
</p>
</div>
<div id="outline-container-orgea8698e" class="outline-3">
<h3 id="orgea8698e">python</h3>
<div class="outline-text-3" id="text-orgea8698e">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #FF7B72;">import</span> requests
<span style="color: #FF7B72;">import</span> json
<span style="color: #FF7B72;">from</span> datetime <span style="color: #FF7B72;">import</span> datetime, timedelta
<span style="color: #FF7B72;">import</span> os
<span style="color: #FF7B72;">from</span> typing <span style="color: #FF7B72;">import</span> List, Dict, Optional
<span style="color: #FF7B72;">from</span> pathlib <span style="color: #FF7B72;">import</span> Path
<span style="color: #FF7B72;">import</span> re
<span style="color: #FF7B72;">from</span> github <span style="color: #FF7B72;">import</span> Github
<span style="color: #FF7B72;">import</span> argparse

<span style="color: #FF7B72;">class</span> <span style="color: #FF7B72; font-style: italic;">ReadwiseAPI</span>:
    <span style="color: #787878; font-style: italic;">"""Readwise API client for exporting highlights with smart update capability and GitHub integration"""</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">__init__</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span><span style="color: #8c8c8c;">)</span>:
        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Initialize Readwise token</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">readwise_token</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"READWISE_TOKEN"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">self</span>.readwise_token:
            <span style="color: #FF7B72;">raise</span> <span style="color: #FF7B72; font-style: italic;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"READWISE_TOKEN not found in environment variables"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Initialize GitHub token</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">github_token</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"GITHUB_TOKEN"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">self</span>.github_token:
            <span style="color: #FF7B72;">raise</span> <span style="color: #FF7B72; font-style: italic;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"GITHUB_TOKEN not found in environment variables"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Get repository from GitHub Actions environment variable</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">github_repo</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"GITHUB_REPOSITORY"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">self</span>.github_repo:
            <span style="color: #FF7B72;">raise</span> <span style="color: #FF7B72; font-style: italic;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Not running in GitHub Actions environment (GITHUB_REPOSITORY not found)"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Initialize GitHub client</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">github</span> = Github<span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>.github_token<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">repo</span> = <span style="color: #FF7B72;">self</span>.github.get_repo<span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>.github_repo<span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Initialize Readwise API settings</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">base_url</span> = <span style="color: #a7bca4;">"https://readwise.io/api/v2"</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">headers</span> = <span style="color: #8c8c8c;">{</span>
            <span style="color: #a7bca4;">"Authorization"</span>: f<span style="color: #a7bca4;">"Token </span>{<span style="color: #FF7B72;">self</span>.readwise_token}<span style="color: #a7bca4;">"</span>
        <span style="color: #8c8c8c;">}</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">last_update_file</span> = <span style="color: #a7bca4;">"last_update.json"</span>
        <span style="color: #FF7B72;">self</span>.<span style="color: #FFA657;">articles_file</span> = <span style="color: #a7bca4;">"articles.json"</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_highlights</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, updated_after: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>,
                      start_date: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>,
                      end_date: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span><span style="color: #8c8c8c;">)</span> -&gt; Dict:
        <span style="color: #787878; font-style: italic;">"""Get all highlights with their associated metadata"""</span>
        <span style="color: #FFA657;">endpoint</span> = f<span style="color: #a7bca4;">"</span>{<span style="color: #FF7B72;">self</span>.base_url}<span style="color: #a7bca4;">/export/"</span>
        <span style="color: #FFA657;">params</span> = <span style="color: #8c8c8c;">{}</span>

        <span style="color: #FF7B72;">if</span> updated_after:
            <span style="color: #FFA657;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #a7bca4;">"updated_after"</span><span style="color: #8c8c8c;">]</span> = updated_after.isoformat<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">elif</span> start_date:
            <span style="color: #FFA657;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #a7bca4;">"updated_after"</span><span style="color: #8c8c8c;">]</span> = start_date.isoformat<span style="color: #8c8c8c;">()</span>
            <span style="color: #FF7B72;">if</span> end_date:
                <span style="color: #FFA657;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #a7bca4;">"updated_before"</span><span style="color: #8c8c8c;">]</span> = end_date.isoformat<span style="color: #8c8c8c;">()</span>

        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Fetching highlights with params: </span>{params}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">response</span> = requests.get<span style="color: #8c8c8c;">(</span>endpoint, headers=<span style="color: #FF7B72;">self</span>.headers, params=params<span style="color: #8c8c8c;">)</span>
        response.raise_for_status<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">return</span> response.json<span style="color: #8c8c8c;">()</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">get_file_content</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, path: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; Optional<span style="color: #8c8c8c;">[</span><span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">]</span>:
        <span style="color: #787878; font-style: italic;">"""Get file content from GitHub repository"""</span>
        <span style="color: #FF7B72;">try</span>:
            <span style="color: #FFA657;">content</span> = <span style="color: #FF7B72;">self</span>.repo.get_contents<span style="color: #8c8c8c;">(</span>path<span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">return</span> content.decoded_content.decode<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'utf-8'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
            <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"File </span>{path}<span style="color: #a7bca4;"> not found in repository: </span>{e}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">return</span> <span style="font-style: italic;">None</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">update_file</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, path: <span style="color: #79C0FF;">str</span>, content: <span style="color: #79C0FF;">str</span>, message: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span>:
        <span style="color: #787878; font-style: italic;">"""Update or create file in GitHub repository"""</span>
        <span style="color: #FF7B72;">try</span>:
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Try to get existing file</span>
            <span style="color: #79C0FF;">file</span> = <span style="color: #FF7B72;">self</span>.repo.get_contents<span style="color: #8c8c8c;">(</span>path<span style="color: #8c8c8c;">)</span>
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Update existing file</span>
            <span style="color: #FF7B72;">self</span>.repo.update_file<span style="color: #8c8c8c;">(</span>
                path=path,
                message=message,
                content=content,
                sha=<span style="color: #79C0FF;">file</span>.sha
            <span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span>:
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Create new file if it doesn't exist</span>
            <span style="color: #FF7B72;">self</span>.repo.create_file<span style="color: #8c8c8c;">(</span>
                path=path,
                message=message,
                content=content
            <span style="color: #8c8c8c;">)</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">clean_title</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, title: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
        <span style="color: #787878; font-style: italic;">"""Clean title by removing newlines and extra spaces"""</span>
        <span style="color: #FFA657;">title</span> = re.sub<span style="color: #8c8c8c;">(</span>r<span style="color: #a7bca4;">'\s+'</span>, <span style="color: #a7bca4;">' '</span>, title.replace<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'</span><span style="font-style: italic;">\n</span><span style="color: #a7bca4;">'</span>, <span style="color: #a7bca4;">' '</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">return</span> title.strip<span style="color: #8c8c8c;">()</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">create_article_json</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, highlights_data: Dict<span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
        <span style="color: #787878; font-style: italic;">"""Create a list of articles with title and URL, only for category 'articles'"""</span>
        <span style="color: #FFA657;">articles</span> = <span style="color: #8c8c8c;">[]</span>

        <span style="color: #FF7B72;">for</span> article <span style="color: #FF7B72;">in</span> highlights_data.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'results'</span>, <span style="color: #93a8c6;">[]</span><span style="color: #8c8c8c;">)</span>:
            <span style="color: #FF7B72;">if</span> article.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'category'</span>, <span style="color: #a7bca4;">''</span><span style="color: #8c8c8c;">)</span>.lower<span style="color: #8c8c8c;">()</span> == <span style="color: #a7bca4;">'articles'</span>:
                <span style="color: #FFA657;">title</span> = <span style="color: #FF7B72;">self</span>.clean_title<span style="color: #8c8c8c;">(</span>article.get<span style="color: #93a8c6;">(</span><span style="color: #a7bca4;">'title'</span>, <span style="color: #a7bca4;">'Untitled'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">url</span> = article.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'source_url'</span>, <span style="color: #a7bca4;">''</span><span style="color: #8c8c8c;">)</span>

                articles.append<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">{</span>
                    <span style="color: #a7bca4;">'title'</span>: title,
                    <span style="color: #a7bca4;">'url'</span>: url
                <span style="color: #93a8c6;">}</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #FF7B72;">return</span> articles

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">load_last_update_from_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span><span style="color: #8c8c8c;">)</span> -&gt; Optional<span style="color: #8c8c8c;">[</span>datetime<span style="color: #8c8c8c;">]</span>:
        <span style="color: #787878; font-style: italic;">"""Load the last update date from GitHub"""</span>
        <span style="color: #FFA657;">content</span> = <span style="color: #FF7B72;">self</span>.get_file_content<span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>.last_update_file<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> content:
            <span style="color: #FF7B72;">try</span>:
                <span style="color: #FFA657;">data</span> = json.loads<span style="color: #8c8c8c;">(</span>content<span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">return</span> datetime.strptime<span style="color: #8c8c8c;">(</span>data<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'last_update'</span><span style="color: #93a8c6;">]</span>, <span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error parsing last update file: </span>{e}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">return</span> <span style="font-style: italic;">None</span>
        <span style="color: #FF7B72;">return</span> <span style="font-style: italic;">None</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">save_last_update_to_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span><span style="color: #8c8c8c;">)</span>:
        <span style="color: #787878; font-style: italic;">"""Save current date as last update date to GitHub"""</span>
        <span style="color: #FFA657;">current_date</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FFA657;">content</span> = json.dumps<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">{</span><span style="color: #a7bca4;">'last_update'</span>: current_date<span style="color: #93a8c6;">}</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">self</span>.update_file<span style="color: #8c8c8c;">(</span>
            path=<span style="color: #FF7B72;">self</span>.last_update_file,
            content=content,
            message=<span style="color: #a7bca4;">"Update last sync date"</span>
        <span style="color: #8c8c8c;">)</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">load_existing_articles_from_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span><span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
        <span style="color: #787878; font-style: italic;">"""Load existing articles from GitHub"""</span>
        <span style="color: #FFA657;">content</span> = <span style="color: #FF7B72;">self</span>.get_file_content<span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>.articles_file<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> content:
            <span style="color: #FF7B72;">try</span>:
                <span style="color: #FF7B72;">return</span> json.loads<span style="color: #8c8c8c;">(</span>content<span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Error parsing articles file: </span>{e}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">return</span> <span style="color: #8c8c8c;">[]</span>
        <span style="color: #FF7B72;">return</span> <span style="color: #8c8c8c;">[]</span>

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">merge_articles</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, existing_articles: List<span style="color: #93a8c6;">[</span>Dict<span style="color: #93a8c6;">]</span>, new_articles: List<span style="color: #93a8c6;">[</span>Dict<span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
        <span style="color: #787878; font-style: italic;">"""Merge new articles with existing ones, avoiding duplicates"""</span>
        <span style="color: #FFA657;">existing_set</span> = <span style="color: #8c8c8c;">{</span><span style="color: #93a8c6;">(</span>article<span style="color: #b0b1a3;">[</span><span style="color: #a7bca4;">'title'</span><span style="color: #b0b1a3;">]</span>, article<span style="color: #b0b1a3;">[</span><span style="color: #a7bca4;">'url'</span><span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">)</span> <span style="color: #FF7B72;">for</span> article <span style="color: #FF7B72;">in</span> existing_articles<span style="color: #8c8c8c;">}</span>

        <span style="color: #FF7B72;">for</span> article <span style="color: #FF7B72;">in</span> new_articles:
            <span style="color: #FFA657;">article_tuple</span> = <span style="color: #8c8c8c;">(</span>article<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'title'</span><span style="color: #93a8c6;">]</span>, article<span style="color: #93a8c6;">[</span><span style="color: #a7bca4;">'url'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">if</span> article_tuple <span style="color: #FF7B72;">not</span> <span style="color: #FF7B72;">in</span> existing_set:
                existing_articles.append<span style="color: #8c8c8c;">(</span>article<span style="color: #8c8c8c;">)</span>
                existing_set.add<span style="color: #8c8c8c;">(</span>article_tuple<span style="color: #8c8c8c;">)</span>

        <span style="color: #FF7B72;">return</span> existing_articles

    <span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">export_articles</span><span style="color: #8c8c8c;">(</span><span style="color: #FF7B72;">self</span>, start_date: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>,
                       end_date: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="font-style: italic;">None</span>,
                       all_time: <span style="color: #79C0FF;">bool</span> = <span style="font-style: italic;">False</span><span style="color: #8c8c8c;">)</span>:
        <span style="color: #787878; font-style: italic;">"""</span>
<span style="color: #787878; font-style: italic;">        Export articles to GitHub with smart update capability</span>

<span style="color: #787878; font-style: italic;">        Args:</span>
<span style="color: #787878; font-style: italic;">            start_date: Optional start date in YYYY-MM-DD format</span>
<span style="color: #787878; font-style: italic;">            end_date: Optional end date in YYYY-MM-DD format</span>
<span style="color: #787878; font-style: italic;">            all_time: If True, fetch all highlights regardless of dates</span>
<span style="color: #787878; font-style: italic;">        """</span>
        <span style="color: #FF7B72;">if</span> all_time:
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#24403;&#36873;&#25321; all_time &#26102;&#65292;&#24378;&#21046;&#33719;&#21462;&#25152;&#26377; highlights&#65292;&#24573;&#30053;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;</span>
            <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Fetching all highlights from the beginning"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FFA657;">highlights_data</span> = <span style="color: #FF7B72;">self</span>.get_highlights<span style="color: #8c8c8c;">()</span>
        <span style="color: #FF7B72;">elif</span> start_date:
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#22914;&#26524;&#25351;&#23450;&#20102;&#24320;&#22987;&#26085;&#26399;&#65292;&#20351;&#29992;&#25351;&#23450;&#30340;&#26085;&#26399;&#33539;&#22260;</span>
            <span style="color: #FFA657;">start_datetime</span> = datetime.strptime<span style="color: #8c8c8c;">(</span>start_date, <span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FFA657;">end_datetime</span> = datetime.strptime<span style="color: #8c8c8c;">(</span>end_date, <span style="color: #a7bca4;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FF7B72;">if</span> end_date <span style="color: #FF7B72;">else</span> datetime.now<span style="color: #8c8c8c;">()</span>
            <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Fetching highlights from </span>{start_date}<span style="color: #a7bca4;"> to </span>{end_date <span style="color: #FF7B72;">or</span> 'now'}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FFA657;">highlights_data</span> = <span style="color: #FF7B72;">self</span>.get_highlights<span style="color: #8c8c8c;">(</span>start_date=start_datetime, end_date=end_datetime<span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">else</span>:
            <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20351;&#29992;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;&#30340;&#22686;&#37327;&#26356;&#26032;&#36923;&#36753;</span>
            <span style="color: #FFA657;">last_update</span> = <span style="color: #FF7B72;">self</span>.load_last_update_from_github<span style="color: #8c8c8c;">()</span>
            <span style="color: #FF7B72;">if</span> last_update:
                <span style="color: #FFA657;">days_since_update</span> = <span style="color: #8c8c8c;">(</span>datetime.now<span style="color: #93a8c6;">()</span> - last_update<span style="color: #8c8c8c;">)</span>.days
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Last update was </span>{days_since_update}<span style="color: #a7bca4;"> days ago on </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">if</span> days_since_update &gt; 0:
                    <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Fetching highlights updated after </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
                    <span style="color: #FFA657;">highlights_data</span> = <span style="color: #FF7B72;">self</span>.get_highlights<span style="color: #8c8c8c;">(</span>updated_after=last_update<span style="color: #8c8c8c;">)</span>
                <span style="color: #FF7B72;">else</span>:
                    <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"Already updated today, no need to fetch new articles"</span><span style="color: #8c8c8c;">)</span>
                    <span style="color: #FF7B72;">return</span>
            <span style="color: #FF7B72;">else</span>:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"No previous update found, fetching all articles"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">highlights_data</span> = <span style="color: #FF7B72;">self</span>.get_highlights<span style="color: #8c8c8c;">()</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Create article data</span>
        <span style="color: #FFA657;">new_articles</span> = <span style="color: #FF7B72;">self</span>.create_article_json<span style="color: #8c8c8c;">(</span>highlights_data<span style="color: #8c8c8c;">)</span>
        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Found </span>{<span style="color: #79C0FF;">len</span>(new_articles)}<span style="color: #a7bca4;"> new articles"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Load existing articles</span>
        <span style="color: #FFA657;">existing_articles</span> = <span style="color: #FF7B72;">self</span>.load_existing_articles_from_github<span style="color: #8c8c8c;">()</span>
        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Found </span>{<span style="color: #79C0FF;">len</span>(existing_articles)}<span style="color: #a7bca4;"> existing articles"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Merge new articles with existing ones</span>
        <span style="color: #FFA657;">merged_articles</span> = <span style="color: #FF7B72;">self</span>.merge_articles<span style="color: #8c8c8c;">(</span>existing_articles, new_articles<span style="color: #8c8c8c;">)</span>
        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Total unique articles after merge: </span>{<span style="color: #79C0FF;">len</span>(merged_articles)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Save merged articles to GitHub</span>
        <span style="color: #FF7B72;">self</span>.update_file<span style="color: #8c8c8c;">(</span>
            path=<span style="color: #FF7B72;">self</span>.articles_file,
            content=json.dumps<span style="color: #93a8c6;">(</span>merged_articles, ensure_ascii=<span style="font-style: italic;">False</span>, indent=2<span style="color: #93a8c6;">)</span>,
            message=<span style="color: #a7bca4;">"Update articles list"</span>
        <span style="color: #8c8c8c;">)</span>

        <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">Update the last update date</span>
        <span style="color: #FF7B72;">if</span> <span style="color: #FF7B72;">not</span> start_date <span style="color: #FF7B72;">and</span> <span style="color: #FF7B72;">not</span> all_time:  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#21482;&#26377;&#22312;&#38750;&#25351;&#23450;&#26085;&#26399;&#33539;&#22260;&#21644;&#38750;&#20840;&#37327;&#26356;&#26032;&#30340;&#24773;&#20917;&#19979;&#25165;&#26356;&#26032;&#26368;&#21518;&#21516;&#27493;&#26102;&#38388;</span>
            <span style="color: #FF7B72;">self</span>.save_last_update_to_github<span style="color: #8c8c8c;">()</span>

        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"Successfully updated articles in GitHub repository"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">if</span> new_articles:
            <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">"New articles added:"</span><span style="color: #8c8c8c;">)</span>
            <span style="color: #FF7B72;">for</span> article <span style="color: #FF7B72;">in</span> new_articles:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"- </span>{article['title']}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>

<span style="color: #FF7B72;">def</span> <span style="color: #D2A8FF;">main</span><span style="color: #8c8c8c;">()</span>:
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20174;&#29615;&#22659;&#21464;&#37327;&#33719;&#21462; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
    <span style="color: #FFA657;">gh_start_date</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'INPUT_START_DATE'</span>, <span style="color: #a7bca4;">''</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">gh_end_date</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'INPUT_END_DATE'</span>, <span style="color: #a7bca4;">''</span><span style="color: #8c8c8c;">)</span>
    <span style="color: #FFA657;">gh_all_time</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'INPUT_ALL_TIME'</span>, <span style="color: #a7bca4;">''</span><span style="color: #8c8c8c;">)</span>.lower<span style="color: #8c8c8c;">()</span> == <span style="color: #a7bca4;">'true'</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#35774;&#32622;&#21629;&#20196;&#34892;&#21442;&#25968;&#35299;&#26512;&#22120;</span>
    <span style="color: #FFA657;">parser</span> = argparse.ArgumentParser<span style="color: #8c8c8c;">(</span>description=<span style="color: #a7bca4;">'Sync Readwise highlights to GitHub'</span><span style="color: #8c8c8c;">)</span>
    parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'--start-date'</span>, <span style="color: #79C0FF;">type</span>=<span style="color: #79C0FF;">str</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #a7bca4;">'Start date in YYYY-MM-DD format'</span><span style="color: #8c8c8c;">)</span>
    parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'--end-date'</span>, <span style="color: #79C0FF;">type</span>=<span style="color: #79C0FF;">str</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #a7bca4;">'End date in YYYY-MM-DD format'</span><span style="color: #8c8c8c;">)</span>
    parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #a7bca4;">'--all-time'</span>, action=<span style="color: #a7bca4;">'store_true'</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #a7bca4;">'Fetch all highlights from the beginning'</span><span style="color: #8c8c8c;">)</span>

    <span style="color: #FFA657;">args</span> = parser.parse_args<span style="color: #8c8c8c;">()</span>

    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20248;&#20808;&#20351;&#29992;&#21629;&#20196;&#34892;&#21442;&#25968;&#65292;&#22914;&#26524;&#27809;&#26377;&#21017;&#20351;&#29992; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
    <span style="color: #FFA657;">start_date</span> = args.start_date <span style="color: #FF7B72;">or</span> gh_start_date
    <span style="color: #FFA657;">end_date</span> = args.end_date <span style="color: #FF7B72;">or</span> gh_end_date
    <span style="color: #FFA657;">all_time</span> = args.all_time <span style="color: #FF7B72;">or</span> gh_all_time

    <span style="color: #FF7B72;">try</span>:
        <span style="color: #FFA657;">client</span> = ReadwiseAPI<span style="color: #8c8c8c;">()</span>
        client.export_articles<span style="color: #8c8c8c;">(</span>
            start_date=start_date <span style="color: #FF7B72;">if</span> start_date <span style="color: #FF7B72;">else</span> <span style="font-style: italic;">None</span>,
            end_date=end_date <span style="color: #FF7B72;">if</span> end_date <span style="color: #FF7B72;">else</span> <span style="font-style: italic;">None</span>,
            all_time=all_time
        <span style="color: #8c8c8c;">)</span>
    <span style="color: #FF7B72;">except</span> <span style="color: #FF7B72; font-style: italic;">Exception</span> <span style="color: #FF7B72;">as</span> e:
        <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #a7bca4;">"An error occurred: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #a7bca4;">"</span><span style="color: #8c8c8c;">)</span>
        <span style="color: #FF7B72;">raise</span>

<span style="color: #FF7B72;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #a7bca4;">"__main__"</span>:
    main<span style="color: #8c8c8c;">()</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-org3c6c127" class="outline-3">
<h3 id="org3c6c127">workflow</h3>
<div class="outline-text-3" id="text-org3c6c127">
<div class="org-src-container">
<pre class="src src-yaml">
<span style="color: #FFA657;">name</span>: Sync Readwise Articles
<span style="font-style: italic;">on</span>:
  <span style="color: #FFA657;">schedule</span>:
    <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#27599;&#22825;&#20940;&#26216; 1 &#28857;&#36816;&#34892; (UTC &#26102;&#38388;&#65292;&#23545;&#24212;&#21271;&#20140;&#26102;&#38388; 9 &#28857;)</span>
    - <span style="color: #FFA657;">cron</span>: <span style="color: #a7bca4;">'0 1 * * *'</span>

  <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#25903;&#25345;&#25163;&#21160;&#35302;&#21457;&#65292;&#24182;&#28155;&#21152;&#36755;&#20837;&#21442;&#25968;</span>
  <span style="color: #FFA657;">workflow_dispatch</span>:
    <span style="color: #FFA657;">inputs</span>:
      <span style="color: #FFA657;">start_date</span>:
        <span style="color: #FFA657;">description</span>: <span style="color: #a7bca4;">'Start date (YYYY-MM-DD, e.g., 2024-01-01)'</span>
        <span style="color: #FFA657;">required</span>: <span style="font-style: italic;">false</span>
        <span style="color: #FFA657;">type</span>: string
        <span style="color: #FFA657;">default</span>: <span style="color: #a7bca4;">''</span>
      <span style="color: #FFA657;">end_date</span>:
        <span style="color: #FFA657;">description</span>: <span style="color: #a7bca4;">'End date (YYYY-MM-DD, leave empty for current date)'</span>
        <span style="color: #FFA657;">required</span>: <span style="font-style: italic;">false</span>
        <span style="color: #FFA657;">type</span>: string
        <span style="color: #FFA657;">default</span>: <span style="color: #a7bca4;">''</span>
      <span style="color: #FFA657;">all_time</span>:
        <span style="color: #FFA657;">description</span>: <span style="color: #a7bca4;">'Fetch all highlights (overrides date range if selected)'</span>
        <span style="color: #FFA657;">type</span>: boolean
        <span style="color: #FFA657;">required</span>: <span style="font-style: italic;">false</span>
        <span style="color: #FFA657;">default</span>: <span style="font-style: italic;">false</span>

<span style="color: #FFA657;">permissions</span>:
  <span style="color: #FFA657;">contents</span>: write      <span style="color: #787878; font-style: italic;"># </span><span style="color: #787878; font-style: italic;">&#20179;&#24211;&#20869;&#23481;&#30340;&#35835;&#20889;&#26435;&#38480;</span>

<span style="color: #FFA657;">jobs</span>:
  <span style="color: #FFA657;">sync</span>:
    <span style="color: #FFA657;">runs-on</span>: ubuntu-latest

    <span style="color: #FFA657;">steps</span>:
    - <span style="color: #FFA657;">name</span>: Checkout repository
      <span style="color: #FFA657;">uses</span>: actions/checkout@v4

    - <span style="color: #FFA657;">name</span>: Set up Python
      <span style="color: #FFA657;">uses</span>: actions/setup-python@v5
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">python-version</span>: <span style="color: #a7bca4;">'3.10'</span>
        <span style="color: #FFA657;">cache</span>: <span style="color: #a7bca4;">'pip'</span>
        <span style="color: #FFA657;">cache-dependency-path</span>: <span style="color: #a7bca4;">'**/requirements.txt'</span>

    - <span style="color: #FFA657;">name</span>: Install dependencies
      <span style="color: #FFA657;">run</span>: |
        <span style="color: #a7bca4;">python -m pip install --upgrade pip</span>
<span style="color: #a7bca4;">        pip install -r requirements.txt</span>

    - <span style="color: #FFA657;">name</span>: Run sync script
      <span style="color: #FFA657;">env</span>:
        <span style="color: #FFA657;">READWISE_TOKEN</span>: ${{ secrets.READWISE_TOKEN }}
        <span style="color: #FFA657;">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style="color: #FFA657;">INPUT_START_DATE</span>: ${{ github.event.inputs.start_date }}
        <span style="color: #FFA657;">INPUT_END_DATE</span>: ${{ github.event.inputs.end_date }}
        <span style="color: #FFA657;">INPUT_ALL_TIME</span>: ${{ github.event.inputs.all_time }}
      <span style="color: #FFA657;">run</span>: python readwise_sync.py

    - <span style="color: #FFA657;">name</span>: Check for changes
      <span style="color: #FFA657;">id</span>: verify-changed-files
      <span style="color: #FFA657;">run</span>: |
        if [ -n <span style="color: #a7bca4;">"$(git status --porcelain)"</span> ]; then
          echo <span style="color: #a7bca4;">"changes_found=true"</span> &gt;&gt; $GITHUB_OUTPUT
<span style="color: #a7bca4;">        else</span>
          echo <span style="color: #a7bca4;">"changes_found=false"</span> &gt;&gt; $GITHUB_OUTPUT
<span style="color: #a7bca4;">        fi</span>

    - <span style="color: #FFA657;">name</span>: Commit changes
      <span style="color: #FFA657;">if</span>: steps.verify-changed-files.outputs.changes_found == <span style="color: #a7bca4;">'true'</span>
      <span style="color: #FFA657;">run</span>: |
        git config --local user.email <span style="color: #a7bca4;">"github-actions[bot]@users.noreply.github.com"</span>
        git config --local user.name <span style="color: #a7bca4;">"github-actions[bot]"</span>
<span style="color: #a7bca4;">        git add articles.json last_update.json</span>
        git commit -m <span style="color: #a7bca4;">"Update Readwise articles [skip ci]"</span> || echo <span style="color: #a7bca4;">"No changes to commit"</span>

    - <span style="color: #FFA657;">name</span>: Push changes
      <span style="color: #FFA657;">if</span>: steps.verify-changed-files.outputs.changes_found == <span style="color: #a7bca4;">'true'</span>
      <span style="color: #FFA657;">uses</span>: ad-m/github-push-action@master
      <span style="color: #FFA657;">with</span>:
        <span style="color: #FFA657;">github_token</span>: ${{ secrets.GITHUB_TOKEN }}
        <span style="color: #FFA657;">branch</span>: ${{ github.ref }}

</pre>
</div>
</div>
</div>
</div>
<div class="taglist"><a href="https://www.vandee.art/tags.html">Tags</a>: <a href="https://www.vandee.art/tag-pkm.html">PKM</a> <a href="https://www.vandee.art/tag-github.html">Github</a> <a href="https://www.vandee.art/tag-python.html">Python</a> <a href="https://www.vandee.art/tag-database.html">Database</a> </div></div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
         <p>
            © 2022-<script>document.write(new Date().getFullYear())</script> Vandee. All rights reserved.
         </p>
        <div class="social-links"></div>
      </footer>

      <a href="#top" aria-label="go to top" title="Go to Top (Alt + G)"
         class="top-link" id="top-link" accesskey="g">
         <i class="fa-solid fa-angle-up fa-2xl"></i>
      </a>

      <script>
        var mybutton = document.getElementById('top-link');
        window.onscroll = function () {
            if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
                mybutton.style.visibility = 'visible';
                mybutton.style.opacity = '1';
            } else {
                mybutton.style.visibility = 'hidden';
                mybutton.style.opacity = '0';
            }
        };
      </script></div>
</body>
</html>
