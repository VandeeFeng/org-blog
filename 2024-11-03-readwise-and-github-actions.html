<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://www.vandee.art/rss.xml"
      title="RSS feed for https://www.vandee.art/">
<title>Readwise 和 GitHub Actions 联用 - 流动知识检索</title>
<meta property="og:title" content="Readwise 和 GitHub Actions 联用 - 流动知识检索">
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.vandee.art/2024-11-03-readwise-and-github-actions.html">
<meta name="author" content="Vandee">
       <meta name="referrer" content="no-referrer">
       <meta name="viewport" content="width=device-width, initial-scale=1.0">

       <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
       <link rel="stylesheet"
             href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css"/>
       <link rel="stylesheet"
             href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.css"/>
       <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>

       <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" defer></script>
       <script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.umd.js" defer></script>
       <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js" defer></script>
       <script defer>
         document.addEventListener("DOMContentLoaded", function () {
           pangu.spacingPage();
         });
       </script>

       <script src="assets/js/app.js" defer></script>
       <script src="assets/js/copyCode.js" defer></script>
       <script src="assets/js/search.js" defer></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://www.vandee.art/">Vandee's Blog</a></h1>
      <nav>
      <a href="https://www.vandee.art/">Home</a>
      <a href="https://wiki.vandee.art">Wiki</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<div class="post-date">03 Nov 2024</div><h1 class="post-title"><a href="https://www.vandee.art/2024-11-03-readwise-and-github-actions.html">Readwise 和 GitHub Actions 联用 - 流动知识检索</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org76d9740">结合之前的 bookmark-collection</a>
<ul>
<li><a href="#org6e4fe33">python</a></li>
<li><a href="#orga75fda5">workflow</a></li>
</ul>
</li>
<li><a href="#org6b04250">Readwise highlights</a>
<ul>
<li><a href="#org49c3abe">python</a></li>
<li><a href="#org10aab25">workflow</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
Readwise 是我体验的最舒服的 after-reading 软件了，之前一直没有利用好它的 API，在 PKM 体系里，也一直没有统一到工作流。在 Claude 的协助下，有了现在的方案：
</p>
<div id="outline-container-org76d9740" class="outline-2">
<h2 id="org76d9740">结合之前的 bookmark-collection</h2>
<div class="outline-text-2" id="text-org76d9740">
<p>
现在使用 <code>osmos::memos</code> 插件保存的时候，会默认也保存到 readwise。添加 <code>#2clip</code> 标签触发 clip 的 workflow。详见： <a href="https://www.vandee.art/2024-10-12-bookmark-and-summary-by-github-actions.html">用 GitHub 仓库做书签和 AI 摘要 - 流动知识检索</a>
</p>

<p>
这样就统一起来了，所有的链接都保存在 bookmark-collection 仓库。有保存价值的会触发 clip workflow 保存原文。
</p>

<p>
主要思路是，在 push 的时候会运行这个 Python 脚本，读取新增内容，获取 URL 使用 readwise 的 API 保存。
</p>
</div>
<div id="outline-container-org6e4fe33" class="outline-3">
<h3 id="org6e4fe33">python</h3>
<div class="outline-text-3" id="text-org6e4fe33">
<div class="org-src-container">
<pre class="src src-python"><span style="color: #51afef;">import</span> os
<span style="color: #51afef;">import</span> re
<span style="color: #51afef;">import</span> logging
<span style="color: #51afef;">import</span> requests
<span style="color: #51afef;">from</span> github <span style="color: #51afef;">import</span> Github

<span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#37197;&#32622;&#26085;&#24535;</span>
logging.basicConfig(
    level=logging.INFO,
    <span style="color: #c678dd;">format</span>=<span style="color: #98be65;">'%(asctime)s - %(message)s'</span>,
    datefmt=<span style="color: #98be65;">'%Y-%m-%d %H:%M:%S'</span>
)

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">get_added_content</span>():
    <span style="color: #83898d;">"""&#33719;&#21462;&#36825;&#27425;&#25552;&#20132;&#26032;&#22686;&#30340;&#20869;&#23481;"""</span>
    <span style="color: #51afef;">try</span>:
        <span style="color: #dcaeea;">g</span> = Github(os.environ[<span style="color: #98be65;">'GITHUB_TOKEN'</span>])
        <span style="color: #dcaeea;">repo</span> = g.get_repo(os.environ[<span style="color: #98be65;">'GITHUB_REPOSITORY'</span>])

        <span style="color: #dcaeea;">commit_sha</span> = os.environ.get(<span style="color: #98be65;">'GITHUB_SHA'</span>)
        <span style="color: #dcaeea;">commit</span> = repo.get_commit(commit_sha)

        <span style="color: #51afef;">for</span> <span style="color: #c678dd;">file</span> <span style="color: #51afef;">in</span> commit.files:
            <span style="color: #51afef;">if</span> <span style="color: #c678dd;">file</span>.filename.endswith(<span style="color: #98be65;">'.md'</span>):
                <span style="color: #51afef;">if</span> <span style="color: #c678dd;">file</span>.patch <span style="color: #51afef;">and</span> <span style="color: #98be65;">'+'</span> <span style="color: #51afef;">in</span> <span style="color: #c678dd;">file</span>.patch:
                    <span style="color: #dcaeea;">added_lines</span> = [line[<span style="color: #da8548; font-weight: bold;">1</span>:] <span style="color: #51afef;">for</span> line <span style="color: #51afef;">in</span> <span style="color: #c678dd;">file</span>.patch.split(<span style="color: #98be65;">'</span><span style="color: #a9a1e1;">\n</span><span style="color: #98be65;">'</span>)
                                 <span style="color: #51afef;">if</span> line.startswith(<span style="color: #98be65;">'+'</span>) <span style="color: #51afef;">and</span> <span style="color: #51afef;">not</span> line.startswith(<span style="color: #98be65;">'+++'</span>)]
                    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#36820;&#22238;&#25152;&#26377;&#26032;&#22686;&#30340;&#34892;</span>
                    <span style="color: #51afef;">return</span> added_lines
        <span style="color: #51afef;">return</span> []

    <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
        logging.error(f<span style="color: #98be65;">"Error getting commit content: </span>{<span style="color: #c678dd;">str</span>(e)}<span style="color: #98be65;">"</span>)
        <span style="color: #51afef;">raise</span>

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">extract_url</span>(line: <span style="color: #c678dd;">str</span>):
    <span style="color: #83898d;">"""&#20174;&#34892;&#20013;&#25552;&#21462;URL"""</span>
    <span style="color: #51afef;">match</span> = re.search(r<span style="color: #98be65;">'\((.*?)\)'</span>, line)
    <span style="color: #51afef;">if</span> <span style="color: #51afef;">match</span>:
        <span style="color: #51afef;">return</span> <span style="color: #51afef;">match</span>.group(<span style="color: #da8548; font-weight: bold;">1</span>)
    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">None</span>

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">has_save_tag</span>(line: <span style="color: #c678dd;">str</span>) -&gt; <span style="color: #c678dd;">bool</span>:
    <span style="color: #83898d;">"""&#26816;&#26597;&#26159;&#21542;&#21253;&#21547; #2clip &#26631;&#31614;"""</span>
    <span style="color: #51afef;">return</span> <span style="color: #c678dd;">bool</span>(re.search(r<span style="color: #98be65;">'#2clip\b'</span>, line))

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">trigger_workflow</span>():
    <span style="color: #83898d;">"""&#35302;&#21457;&#21478;&#19968;&#20010;workflow"""</span>
    <span style="color: #51afef;">try</span>:
        <span style="color: #dcaeea;">g</span> = Github(os.environ[<span style="color: #98be65;">'GITHUB_TOKEN'</span>])
        <span style="color: #dcaeea;">repo</span> = g.get_repo(os.environ[<span style="color: #98be65;">'GITHUB_REPOSITORY'</span>])

        <span style="color: #dcaeea;">workflow</span> = repo.get_workflow(<span style="color: #98be65;">"convert-markdown.yml"</span>)
        workflow.create_dispatch(<span style="color: #98be65;">"main"</span>)
        logging.info(<span style="color: #98be65;">"Successfully triggered the convert-markdown workflow"</span>)
    <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
        logging.error(f<span style="color: #98be65;">"Failed to trigger workflow: </span>{<span style="color: #c678dd;">str</span>(e)}<span style="color: #98be65;">"</span>)
        <span style="color: #51afef;">raise</span>

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">main</span>():
    <span style="color: #51afef;">try</span>:
        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#33719;&#21462;&#25152;&#26377;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #dcaeea;">added_lines</span> = get_added_content()
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> added_lines:
            logging.info(<span style="color: #98be65;">"No new markdown content found in this commit"</span>)
            <span style="color: #51afef;">return</span>

        <span style="color: #dcaeea;">trigger_needed</span> = <span style="color: #a9a1e1;">False</span>

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#22788;&#29702;&#27599;&#19968;&#34892;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
        <span style="color: #51afef;">for</span> line <span style="color: #51afef;">in</span> added_lines:
            <span style="color: #dcaeea;">line</span> = line.strip()
            logging.info(f<span style="color: #98be65;">"Processing line: </span>{line}<span style="color: #98be65;">"</span>)

            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#26816;&#26597;&#26631;&#31614;</span>
            <span style="color: #51afef;">if</span> has_save_tag(line):
                <span style="color: #dcaeea;">trigger_needed</span> = <span style="color: #a9a1e1;">True</span>

            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#25552;&#21462;&#24182;&#22788;&#29702;URL</span>
            <span style="color: #dcaeea;">url</span> = extract_url(line)
            <span style="color: #51afef;">if</span> url:
                <span style="color: #dcaeea;">response</span> = requests.post(
                    url=<span style="color: #98be65;">"https://readwise.io/api/v3/save/"</span>,
                    headers={<span style="color: #98be65;">"Authorization"</span>: f<span style="color: #98be65;">"Token </span>{os.environ['READWISE_TOKEN']}<span style="color: #98be65;">"</span>},
                    json={
                        <span style="color: #98be65;">"url"</span>: url,
                        <span style="color: #98be65;">"tags"</span>: [<span style="color: #98be65;">"bookmark"</span>]
                    }
                )
                response.raise_for_status()
                logging.info(f<span style="color: #98be65;">"Successfully saved URL: </span>{url}<span style="color: #98be65;">"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#22914;&#26524;&#21457;&#29616;&#20102;&#26631;&#31614;&#65292;&#35302;&#21457;workflow</span>
        <span style="color: #51afef;">if</span> trigger_needed:
            logging.info(<span style="color: #98be65;">"Found #savemd tag, triggering workflow"</span>)
            trigger_workflow()

    <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
        logging.error(f<span style="color: #98be65;">"Error: </span>{<span style="color: #c678dd;">str</span>(e)}<span style="color: #98be65;">"</span>)
        <span style="color: #51afef;">raise</span>

<span style="color: #51afef;">if</span> <span style="color: #c678dd;">__name__</span> == <span style="color: #98be65;">"__main__"</span>:
    main()
</pre>
</div>
</div>
</div>
<div id="outline-container-orga75fda5" class="outline-3">
<h3 id="orga75fda5">workflow</h3>
<div class="outline-text-3" id="text-orga75fda5">
<div class="org-src-container">
<pre class="src src-yml">
name: Save Bookmark to Readwise

on:
  push:
    branches:
      - main
    paths:
      - '**.md'
  workflow_dispatch:

permissions:
  contents: read
  actions: write

jobs:
  save-to-readwise:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests PyGithub

    - name: Run bookmark saver
      env:
        READWISE_TOKEN: ${{ secrets.READWISE_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: python save_to_readwise.py

</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6b04250" class="outline-2">
<h2 id="org6b04250">Readwise highlights</h2>
<div class="outline-text-2" id="text-org6b04250">
<p>
写了一个 <code>class ReadwiseAPI</code> 方便其他项目引入。可以定时获取我所有 highlights 的 title 和 url。
</p>
</div>
<div id="outline-container-org49c3abe" class="outline-3">
<h3 id="org49c3abe">python</h3>
<div class="outline-text-3" id="text-org49c3abe">
<div class="org-src-container">
<pre class="src src-python">
<span style="color: #51afef;">import</span> requests
<span style="color: #51afef;">import</span> json
<span style="color: #51afef;">from</span> datetime <span style="color: #51afef;">import</span> datetime, timedelta
<span style="color: #51afef;">import</span> os
<span style="color: #51afef;">from</span> typing <span style="color: #51afef;">import</span> List, Dict, Optional
<span style="color: #51afef;">from</span> pathlib <span style="color: #51afef;">import</span> Path
<span style="color: #51afef;">import</span> re
<span style="color: #51afef;">from</span> github <span style="color: #51afef;">import</span> Github
<span style="color: #51afef;">import</span> argparse

<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">ReadwiseAPI</span>:
    <span style="color: #83898d;">"""Readwise API client for exporting highlights with smart update capability and GitHub integration"""</span>

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">__init__</span>(<span style="color: #51afef;">self</span>):
        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Initialize Readwise token</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">readwise_token</span> = os.environ.get(<span style="color: #98be65;">"READWISE_TOKEN"</span>)
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> <span style="color: #51afef;">self</span>.readwise_token:
            <span style="color: #51afef;">raise</span> <span style="color: #ECBE7B;">ValueError</span>(<span style="color: #98be65;">"READWISE_TOKEN not found in environment variables"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Initialize GitHub token</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">github_token</span> = os.environ.get(<span style="color: #98be65;">"GITHUB_TOKEN"</span>)
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> <span style="color: #51afef;">self</span>.github_token:
            <span style="color: #51afef;">raise</span> <span style="color: #ECBE7B;">ValueError</span>(<span style="color: #98be65;">"GITHUB_TOKEN not found in environment variables"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Get repository from GitHub Actions environment variable</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">github_repo</span> = os.environ.get(<span style="color: #98be65;">"GITHUB_REPOSITORY"</span>)
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> <span style="color: #51afef;">self</span>.github_repo:
            <span style="color: #51afef;">raise</span> <span style="color: #ECBE7B;">ValueError</span>(<span style="color: #98be65;">"Not running in GitHub Actions environment (GITHUB_REPOSITORY not found)"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Initialize GitHub client</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">github</span> = Github(<span style="color: #51afef;">self</span>.github_token)
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">repo</span> = <span style="color: #51afef;">self</span>.github.get_repo(<span style="color: #51afef;">self</span>.github_repo)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Initialize Readwise API settings</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">base_url</span> = <span style="color: #98be65;">"https://readwise.io/api/v2"</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">headers</span> = {
            <span style="color: #98be65;">"Authorization"</span>: f<span style="color: #98be65;">"Token </span>{<span style="color: #51afef;">self</span>.readwise_token}<span style="color: #98be65;">"</span>
        }
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">last_update_file</span> = <span style="color: #98be65;">"last_update.json"</span>
        <span style="color: #51afef;">self</span>.<span style="color: #dcaeea;">articles_file</span> = <span style="color: #98be65;">"articles.json"</span>

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">get_highlights</span>(<span style="color: #51afef;">self</span>, updated_after: Optional[datetime] = <span style="color: #a9a1e1;">None</span>,
                      start_date: Optional[datetime] = <span style="color: #a9a1e1;">None</span>,
                      end_date: Optional[datetime] = <span style="color: #a9a1e1;">None</span>) -&gt; Dict:
        <span style="color: #83898d;">"""Get all highlights with their associated metadata"""</span>
        <span style="color: #dcaeea;">endpoint</span> = f<span style="color: #98be65;">"</span>{<span style="color: #51afef;">self</span>.base_url}<span style="color: #98be65;">/export/"</span>
        <span style="color: #dcaeea;">params</span> = {}

        <span style="color: #51afef;">if</span> updated_after:
            <span style="color: #dcaeea;">params</span>[<span style="color: #98be65;">"updated_after"</span>] = updated_after.isoformat()
        <span style="color: #51afef;">elif</span> start_date:
            <span style="color: #dcaeea;">params</span>[<span style="color: #98be65;">"updated_after"</span>] = start_date.isoformat()
            <span style="color: #51afef;">if</span> end_date:
                <span style="color: #dcaeea;">params</span>[<span style="color: #98be65;">"updated_before"</span>] = end_date.isoformat()

        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Fetching highlights with params: </span>{params}<span style="color: #98be65;">"</span>)
        <span style="color: #dcaeea;">response</span> = requests.get(endpoint, headers=<span style="color: #51afef;">self</span>.headers, params=params)
        response.raise_for_status()
        <span style="color: #51afef;">return</span> response.json()

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">get_file_content</span>(<span style="color: #51afef;">self</span>, path: <span style="color: #c678dd;">str</span>) -&gt; Optional[<span style="color: #c678dd;">str</span>]:
        <span style="color: #83898d;">"""Get file content from GitHub repository"""</span>
        <span style="color: #51afef;">try</span>:
            <span style="color: #dcaeea;">content</span> = <span style="color: #51afef;">self</span>.repo.get_contents(path)
            <span style="color: #51afef;">return</span> content.decoded_content.decode(<span style="color: #98be65;">'utf-8'</span>)
        <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
            <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"File </span>{path}<span style="color: #98be65;"> not found in repository: </span>{e}<span style="color: #98be65;">"</span>)
            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">None</span>

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">update_file</span>(<span style="color: #51afef;">self</span>, path: <span style="color: #c678dd;">str</span>, content: <span style="color: #c678dd;">str</span>, message: <span style="color: #c678dd;">str</span>):
        <span style="color: #83898d;">"""Update or create file in GitHub repository"""</span>
        <span style="color: #51afef;">try</span>:
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Try to get existing file</span>
            <span style="color: #c678dd;">file</span> = <span style="color: #51afef;">self</span>.repo.get_contents(path)
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Update existing file</span>
            <span style="color: #51afef;">self</span>.repo.update_file(
                path=path,
                message=message,
                content=content,
                sha=<span style="color: #c678dd;">file</span>.sha
            )
        <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span>:
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create new file if it doesn't exist</span>
            <span style="color: #51afef;">self</span>.repo.create_file(
                path=path,
                message=message,
                content=content
            )

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">clean_title</span>(<span style="color: #51afef;">self</span>, title: <span style="color: #c678dd;">str</span>) -&gt; <span style="color: #c678dd;">str</span>:
        <span style="color: #83898d;">"""Clean title by removing newlines and extra spaces"""</span>
        <span style="color: #dcaeea;">title</span> = re.sub(r<span style="color: #98be65;">'\s+'</span>, <span style="color: #98be65;">' '</span>, title.replace(<span style="color: #98be65;">'</span><span style="color: #a9a1e1;">\n</span><span style="color: #98be65;">'</span>, <span style="color: #98be65;">' '</span>))
        <span style="color: #51afef;">return</span> title.strip()

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">create_article_json</span>(<span style="color: #51afef;">self</span>, highlights_data: Dict) -&gt; List[Dict]:
        <span style="color: #83898d;">"""Create a list of articles with title and URL, only for category 'articles'"""</span>
        <span style="color: #dcaeea;">articles</span> = []

        <span style="color: #51afef;">for</span> article <span style="color: #51afef;">in</span> highlights_data.get(<span style="color: #98be65;">'results'</span>, []):
            <span style="color: #51afef;">if</span> article.get(<span style="color: #98be65;">'category'</span>, <span style="color: #98be65;">''</span>).lower() == <span style="color: #98be65;">'articles'</span>:
                <span style="color: #dcaeea;">title</span> = <span style="color: #51afef;">self</span>.clean_title(article.get(<span style="color: #98be65;">'title'</span>, <span style="color: #98be65;">'Untitled'</span>))
                <span style="color: #dcaeea;">url</span> = article.get(<span style="color: #98be65;">'source_url'</span>, <span style="color: #98be65;">''</span>)

                articles.append({
                    <span style="color: #98be65;">'title'</span>: title,
                    <span style="color: #98be65;">'url'</span>: url
                })

        <span style="color: #51afef;">return</span> articles

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">load_last_update_from_github</span>(<span style="color: #51afef;">self</span>) -&gt; Optional[datetime]:
        <span style="color: #83898d;">"""Load the last update date from GitHub"""</span>
        <span style="color: #dcaeea;">content</span> = <span style="color: #51afef;">self</span>.get_file_content(<span style="color: #51afef;">self</span>.last_update_file)
        <span style="color: #51afef;">if</span> content:
            <span style="color: #51afef;">try</span>:
                <span style="color: #dcaeea;">data</span> = json.loads(content)
                <span style="color: #51afef;">return</span> datetime.strptime(data[<span style="color: #98be65;">'last_update'</span>], <span style="color: #98be65;">'%Y-%m-%d'</span>)
            <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
                <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Error parsing last update file: </span>{e}<span style="color: #98be65;">"</span>)
                <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">None</span>
        <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">None</span>

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">save_last_update_to_github</span>(<span style="color: #51afef;">self</span>):
        <span style="color: #83898d;">"""Save current date as last update date to GitHub"""</span>
        <span style="color: #dcaeea;">current_date</span> = datetime.now().strftime(<span style="color: #98be65;">'%Y-%m-%d'</span>)
        <span style="color: #dcaeea;">content</span> = json.dumps({<span style="color: #98be65;">'last_update'</span>: current_date})
        <span style="color: #51afef;">self</span>.update_file(
            path=<span style="color: #51afef;">self</span>.last_update_file,
            content=content,
            message=<span style="color: #98be65;">"Update last sync date"</span>
        )

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">load_existing_articles_from_github</span>(<span style="color: #51afef;">self</span>) -&gt; List[Dict]:
        <span style="color: #83898d;">"""Load existing articles from GitHub"""</span>
        <span style="color: #dcaeea;">content</span> = <span style="color: #51afef;">self</span>.get_file_content(<span style="color: #51afef;">self</span>.articles_file)
        <span style="color: #51afef;">if</span> content:
            <span style="color: #51afef;">try</span>:
                <span style="color: #51afef;">return</span> json.loads(content)
            <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
                <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Error parsing articles file: </span>{e}<span style="color: #98be65;">"</span>)
                <span style="color: #51afef;">return</span> []
        <span style="color: #51afef;">return</span> []

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">merge_articles</span>(<span style="color: #51afef;">self</span>, existing_articles: List[Dict], new_articles: List[Dict]) -&gt; List[Dict]:
        <span style="color: #83898d;">"""Merge new articles with existing ones, avoiding duplicates"""</span>
        <span style="color: #dcaeea;">existing_set</span> = {(article[<span style="color: #98be65;">'title'</span>], article[<span style="color: #98be65;">'url'</span>]) <span style="color: #51afef;">for</span> article <span style="color: #51afef;">in</span> existing_articles}

        <span style="color: #51afef;">for</span> article <span style="color: #51afef;">in</span> new_articles:
            <span style="color: #dcaeea;">article_tuple</span> = (article[<span style="color: #98be65;">'title'</span>], article[<span style="color: #98be65;">'url'</span>])
            <span style="color: #51afef;">if</span> article_tuple <span style="color: #51afef;">not</span> <span style="color: #51afef;">in</span> existing_set:
                existing_articles.append(article)
                existing_set.add(article_tuple)

        <span style="color: #51afef;">return</span> existing_articles

    <span style="color: #51afef;">def</span> <span style="color: #c678dd;">export_articles</span>(<span style="color: #51afef;">self</span>, start_date: Optional[<span style="color: #c678dd;">str</span>] = <span style="color: #a9a1e1;">None</span>,
                       end_date: Optional[<span style="color: #c678dd;">str</span>] = <span style="color: #a9a1e1;">None</span>,
                       all_time: <span style="color: #c678dd;">bool</span> = <span style="color: #a9a1e1;">False</span>):
        <span style="color: #83898d;">"""</span>
<span style="color: #83898d;">        Export articles to GitHub with smart update capability</span>

<span style="color: #83898d;">        Args:</span>
<span style="color: #83898d;">            start_date: Optional start date in YYYY-MM-DD format</span>
<span style="color: #83898d;">            end_date: Optional end date in YYYY-MM-DD format</span>
<span style="color: #83898d;">            all_time: If True, fetch all highlights regardless of dates</span>
<span style="color: #83898d;">        """</span>
        <span style="color: #51afef;">if</span> all_time:
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#24403;&#36873;&#25321; all_time &#26102;&#65292;&#24378;&#21046;&#33719;&#21462;&#25152;&#26377; highlights&#65292;&#24573;&#30053;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;</span>
            <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Fetching all highlights from the beginning"</span>)
            <span style="color: #dcaeea;">highlights_data</span> = <span style="color: #51afef;">self</span>.get_highlights()
        <span style="color: #51afef;">elif</span> start_date:
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#22914;&#26524;&#25351;&#23450;&#20102;&#24320;&#22987;&#26085;&#26399;&#65292;&#20351;&#29992;&#25351;&#23450;&#30340;&#26085;&#26399;&#33539;&#22260;</span>
            <span style="color: #dcaeea;">start_datetime</span> = datetime.strptime(start_date, <span style="color: #98be65;">'%Y-%m-%d'</span>)
            <span style="color: #dcaeea;">end_datetime</span> = datetime.strptime(end_date, <span style="color: #98be65;">'%Y-%m-%d'</span>) <span style="color: #51afef;">if</span> end_date <span style="color: #51afef;">else</span> datetime.now()
            <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Fetching highlights from </span>{start_date}<span style="color: #98be65;"> to </span>{end_date <span style="color: #51afef;">or</span> 'now'}<span style="color: #98be65;">"</span>)
            <span style="color: #dcaeea;">highlights_data</span> = <span style="color: #51afef;">self</span>.get_highlights(start_date=start_datetime, end_date=end_datetime)
        <span style="color: #51afef;">else</span>:
            <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#20351;&#29992;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;&#30340;&#22686;&#37327;&#26356;&#26032;&#36923;&#36753;</span>
            <span style="color: #dcaeea;">last_update</span> = <span style="color: #51afef;">self</span>.load_last_update_from_github()
            <span style="color: #51afef;">if</span> last_update:
                <span style="color: #dcaeea;">days_since_update</span> = (datetime.now() - last_update).days
                <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Last update was </span>{days_since_update}<span style="color: #98be65;"> days ago on </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #98be65;">"</span>)
                <span style="color: #51afef;">if</span> days_since_update &gt; <span style="color: #da8548; font-weight: bold;">0</span>:
                    <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Fetching highlights updated after </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #98be65;">"</span>)
                    <span style="color: #dcaeea;">highlights_data</span> = <span style="color: #51afef;">self</span>.get_highlights(updated_after=last_update)
                <span style="color: #51afef;">else</span>:
                    <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"Already updated today, no need to fetch new articles"</span>)
                    <span style="color: #51afef;">return</span>
            <span style="color: #51afef;">else</span>:
                <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"No previous update found, fetching all articles"</span>)
                <span style="color: #dcaeea;">highlights_data</span> = <span style="color: #51afef;">self</span>.get_highlights()

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Create article data</span>
        <span style="color: #dcaeea;">new_articles</span> = <span style="color: #51afef;">self</span>.create_article_json(highlights_data)
        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Found </span>{<span style="color: #c678dd;">len</span>(new_articles)}<span style="color: #98be65;"> new articles"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Load existing articles</span>
        <span style="color: #dcaeea;">existing_articles</span> = <span style="color: #51afef;">self</span>.load_existing_articles_from_github()
        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Found </span>{<span style="color: #c678dd;">len</span>(existing_articles)}<span style="color: #98be65;"> existing articles"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Merge new articles with existing ones</span>
        <span style="color: #dcaeea;">merged_articles</span> = <span style="color: #51afef;">self</span>.merge_articles(existing_articles, new_articles)
        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Total unique articles after merge: </span>{<span style="color: #c678dd;">len</span>(merged_articles)}<span style="color: #98be65;">"</span>)

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Save merged articles to GitHub</span>
        <span style="color: #51afef;">self</span>.update_file(
            path=<span style="color: #51afef;">self</span>.articles_file,
            content=json.dumps(merged_articles, ensure_ascii=<span style="color: #a9a1e1;">False</span>, indent=<span style="color: #da8548; font-weight: bold;">2</span>),
            message=<span style="color: #98be65;">"Update articles list"</span>
        )

        <span style="color: #5B6268;"># </span><span style="color: #5B6268;">Update the last update date</span>
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">not</span> start_date <span style="color: #51afef;">and</span> <span style="color: #51afef;">not</span> all_time:  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#21482;&#26377;&#22312;&#38750;&#25351;&#23450;&#26085;&#26399;&#33539;&#22260;&#21644;&#38750;&#20840;&#37327;&#26356;&#26032;&#30340;&#24773;&#20917;&#19979;&#25165;&#26356;&#26032;&#26368;&#21518;&#21516;&#27493;&#26102;&#38388;</span>
            <span style="color: #51afef;">self</span>.save_last_update_to_github()

        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"Successfully updated articles in GitHub repository"</span>)
        <span style="color: #51afef;">if</span> new_articles:
            <span style="color: #c678dd;">print</span>(<span style="color: #98be65;">"New articles added:"</span>)
            <span style="color: #51afef;">for</span> article <span style="color: #51afef;">in</span> new_articles:
                <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"- </span>{article['title']}<span style="color: #98be65;">"</span>)

<span style="color: #51afef;">def</span> <span style="color: #c678dd;">main</span>():
    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#20174;&#29615;&#22659;&#21464;&#37327;&#33719;&#21462; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
    <span style="color: #dcaeea;">gh_start_date</span> = os.environ.get(<span style="color: #98be65;">'INPUT_START_DATE'</span>, <span style="color: #98be65;">''</span>)
    <span style="color: #dcaeea;">gh_end_date</span> = os.environ.get(<span style="color: #98be65;">'INPUT_END_DATE'</span>, <span style="color: #98be65;">''</span>)
    <span style="color: #dcaeea;">gh_all_time</span> = os.environ.get(<span style="color: #98be65;">'INPUT_ALL_TIME'</span>, <span style="color: #98be65;">''</span>).lower() == <span style="color: #98be65;">'true'</span>

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#35774;&#32622;&#21629;&#20196;&#34892;&#21442;&#25968;&#35299;&#26512;&#22120;</span>
    <span style="color: #dcaeea;">parser</span> = argparse.ArgumentParser(description=<span style="color: #98be65;">'Sync Readwise highlights to GitHub'</span>)
    parser.add_argument(<span style="color: #98be65;">'--start-date'</span>, <span style="color: #c678dd;">type</span>=<span style="color: #c678dd;">str</span>, <span style="color: #c678dd;">help</span>=<span style="color: #98be65;">'Start date in YYYY-MM-DD format'</span>)
    parser.add_argument(<span style="color: #98be65;">'--end-date'</span>, <span style="color: #c678dd;">type</span>=<span style="color: #c678dd;">str</span>, <span style="color: #c678dd;">help</span>=<span style="color: #98be65;">'End date in YYYY-MM-DD format'</span>)
    parser.add_argument(<span style="color: #98be65;">'--all-time'</span>, action=<span style="color: #98be65;">'store_true'</span>, <span style="color: #c678dd;">help</span>=<span style="color: #98be65;">'Fetch all highlights from the beginning'</span>)

    <span style="color: #dcaeea;">args</span> = parser.parse_args()

    <span style="color: #5B6268;"># </span><span style="color: #5B6268;">&#20248;&#20808;&#20351;&#29992;&#21629;&#20196;&#34892;&#21442;&#25968;&#65292;&#22914;&#26524;&#27809;&#26377;&#21017;&#20351;&#29992; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
    <span style="color: #dcaeea;">start_date</span> = args.start_date <span style="color: #51afef;">or</span> gh_start_date
    <span style="color: #dcaeea;">end_date</span> = args.end_date <span style="color: #51afef;">or</span> gh_end_date
    <span style="color: #dcaeea;">all_time</span> = args.all_time <span style="color: #51afef;">or</span> gh_all_time

    <span style="color: #51afef;">try</span>:
        <span style="color: #dcaeea;">client</span> = ReadwiseAPI()
        client.export_articles(
            start_date=start_date <span style="color: #51afef;">if</span> start_date <span style="color: #51afef;">else</span> <span style="color: #a9a1e1;">None</span>,
            end_date=end_date <span style="color: #51afef;">if</span> end_date <span style="color: #51afef;">else</span> <span style="color: #a9a1e1;">None</span>,
            all_time=all_time
        )
    <span style="color: #51afef;">except</span> <span style="color: #ECBE7B;">Exception</span> <span style="color: #51afef;">as</span> e:
        <span style="color: #c678dd;">print</span>(f<span style="color: #98be65;">"An error occurred: </span>{<span style="color: #c678dd;">str</span>(e)}<span style="color: #98be65;">"</span>)
        <span style="color: #51afef;">raise</span>

<span style="color: #51afef;">if</span> <span style="color: #c678dd;">__name__</span> == <span style="color: #98be65;">"__main__"</span>:
    main()

</pre>
</div>
</div>
</div>
<div id="outline-container-org10aab25" class="outline-3">
<h3 id="org10aab25">workflow</h3>
<div class="outline-text-3" id="text-org10aab25">
<div class="org-src-container">
<pre class="src src-yml">
name: Sync Readwise Articles
on:
  schedule:
    # 每天凌晨 1 点运行 (UTC 时间，对应北京时间 9 点)
    - cron: '0 1 * * *'

  # 支持手动触发，并添加输入参数
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (YYYY-MM-DD, e.g., 2024-01-01)'
        required: false
        type: string
        default: ''
      end_date:
        description: 'End date (YYYY-MM-DD, leave empty for current date)'
        required: false
        type: string
        default: ''
      all_time:
        description: 'Fetch all highlights (overrides date range if selected)'
        type: boolean
        required: false
        default: false

permissions:
  contents: write      # 仓库内容的读写权限

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
        cache: 'pip'
        cache-dependency-path: '**/requirements.txt'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run sync script
      env:
        READWISE_TOKEN: ${{ secrets.READWISE_TOKEN }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        INPUT_START_DATE: ${{ github.event.inputs.start_date }}
        INPUT_END_DATE: ${{ github.event.inputs.end_date }}
        INPUT_ALL_TIME: ${{ github.event.inputs.all_time }}
      run: python readwise_sync.py

    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changes_found=true" &gt;&gt; $GITHUB_OUTPUT
        else
          echo "changes_found=false" &gt;&gt; $GITHUB_OUTPUT
        fi

    - name: Commit changes
      if: steps.verify-changed-files.outputs.changes_found == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add articles.json last_update.json
        git commit -m "Update Readwise articles [skip ci]" || echo "No changes to commit"

    - name: Push changes
      if: steps.verify-changed-files.outputs.changes_found == 'true'
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}

</pre>
</div>
</div>
</div>
</div>
<div class="taglist"><a href="https://www.vandee.art/tags.html">Tags</a>: <a href="https://www.vandee.art/tag-pkm.html">PKM</a> <a href="https://www.vandee.art/tag-github.html">Github</a> <a href="https://www.vandee.art/tag-python.html">Python</a> </div></div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <p>© 2022-2024 Vandee. Some rights reserved.</p>
        <div class="social-links"></div>
      </footer>

      <a href="#top" aria-label="go to top" title="Go to Top (Alt + G)"
         class="top-link" id="top-link" accesskey="g">
         <i class="fa-solid fa-angle-up fa-2xl"></i>
      </a>

      <script>
        var mybutton = document.getElementById('top-link');
        window.onscroll = function () {
            if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
                mybutton.style.visibility = 'visible';
                mybutton.style.opacity = '1';
            } else {
                mybutton.style.visibility = 'hidden';
                mybutton.style.opacity = '0';
            }
        };
      </script></div>
</body>
</html>
