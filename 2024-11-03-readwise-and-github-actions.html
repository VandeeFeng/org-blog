<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <link rel="alternate"
          type="application/rss+xml"
          href="https://www.vandee.art/rss.xml"
          title="RSS feed for https://www.vandee.art/">
    <title>Readwise 和 GitHub Actions 联用 - 流动知识检索</title>
    <meta property="og:title" content="Readwise 和 GitHub Actions 联用 - 流动知识检索">
    <meta property="og:type" content="article" />
    <meta property="og:url" content="https://www.vandee.art/2024-11-03-readwise-and-github-actions.html">
    <meta name="author" content="Vandee">
    <meta name="referrer" content="no-referrer">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="assets/css/style.css" type="text/css"/>
    <link rel="stylesheet"
          href="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/6.0.0/css/all.min.css"/>
    <link rel="stylesheet"
          href="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.css"/>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico"/>

    <script src="https://lf6-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js" defer></script>
    <script src="https://testingcf.jsdelivr.net/npm/@fancyapps/ui@4.0.12/dist/fancybox.umd.js" defer></script>
    <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js" defer></script>
    <script defer>
      document.addEventListener("DOMContentLoaded", function () {
        pangu.spacingPage();
      });
    </script>

    <script src="assets/js/app.js" defer></script>
    <script src="assets/js/copyCode.js" defer></script>
    <script src="assets/js/search.js" defer></script></head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1><a href="https://www.vandee.art/">Vandee's Blog</a></h1>
        <nav>
          <a href="https://www.vandee.art/">Home</a>
          <a href="https://x.vandee.art/wiki">Wiki</a>
          <a href="https://x.vandee.art/photo">Photo</a>
          <a href="archive.html">Archive</a>
          <a href="tags.html">Tags</a>
          <div id="search-container">
            <input type="text" id="search-input" placeholder="e.g. Emacs PKM...">
            <i class="fas fa-search search-icon"></i>
          </div>
        </nav>
    </header></div>
    <div id="content">
      <div class="post-date">03 Nov 2024</div><h1 class="post-title"><a href="https://www.vandee.art/2024-11-03-readwise-and-github-actions.html">Readwise 和 GitHub Actions 联用 - 流动知识检索</a></h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#orgdfa2ec1">结合之前的 bookmark-collection</a>
              <ul>
                <li><a href="#orgab77daa">python</a></li>
                <li><a href="#org7398da1">workflow</a></li>
              </ul>
            </li>
            <li><a href="#org0887e7a">Readwise highlights</a>
              <ul>
                <li><a href="#org253094a">python</a></li>
                <li><a href="#org56cc527">workflow</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        Readwise 是我体验的最舒服的 after-reading 软件了，之前一直没有利用好它的 API，在 PKM 体系里，也一直没有统一到工作流。在 Claude 的协助下，有了现在的方案：
      </p>

      <div id="outline-container-orgdfa2ec1" class="outline-2">
        <h2 id="orgdfa2ec1">结合之前的 bookmark-collection</h2>
        <div class="outline-text-2" id="text-orgdfa2ec1">
          <p>
            现在使用 <code>osmos::memos</code> 插件保存的时候，会默认也保存到 readwise。添加 <code>#2clip</code> 标签触发 clip 的 workflow。详见： <a href="https://www.vandee.art/2024-10-12-bookmark-and-summary-by-github-actions.html">用 GitHub 仓库做书签和 AI 摘要 - 流动知识检索</a>
          </p>

          <p>
            这样就统一起来了。所有的链接都保存在 bookmark-collection 仓库作为中转站，然后统一在 Readwise 里阅读，导出 highlights。有保存价值的会触发 clip workflow 保存原文。
          </p>

          <p>
            主要思路：在 push 的时候会运行这个 Python 脚本，读取新增内容，获取 URL 并使用 Readwise Reader 的 API 保存到 Readwise Reader。Readwise 和 Readwise Reader 是两个 API。
          </p>

          <p>
            需要在仓库的 secret 里增加一个 <code>READWISE_TOKEN</code> secert，填入自己的 Readwise API。
          </p>
        </div>
        <div id="outline-container-orgab77daa" class="outline-3">
          <h3 id="orgab77daa">python</h3>
          <div class="outline-text-3" id="text-orgab77daa">
            <div class="org-src-container">
              <pre class="src src-python"><span style="color: #FFA657;">import</span> os
                <span style="color: #FFA657;">import</span> re
                <span style="color: #FFA657;">import</span> logging
                <span style="color: #FFA657;">import</span> requests
                <span style="color: #FFA657;">from</span> github <span style="color: #FFA657;">import</span> Github

                logging.basicConfig<span style="color: #8c8c8c;">(</span>
                level=logging.INFO,
                <span style="color: #79C0FF;">format</span>=<span style="color: #A1D08E;">'%(asctime)s - %(message)s'</span>,
                datefmt=<span style="color: #A1D08E;">'%Y-%m-%d %H:%M:%S'</span>
                <span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">get_added_content</span><span style="color: #8c8c8c;">()</span>:
                <span style="color: #787878;">"""&#33719;&#21462;&#36825;&#27425;&#25552;&#20132;&#26032;&#22686;&#30340;&#20869;&#23481;"""</span>
                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #f4f4ff;">commit_sha</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'GITHUB_SHA'</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">commit</span> = repo.get_commit<span style="color: #8c8c8c;">(</span>commit_sha<span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">for</span> <span style="color: #79C0FF;">file</span> <span style="color: #FFA657;">in</span> commit.files:
                <span style="color: #FFA657;">if</span> <span style="color: #79C0FF;">file</span>.filename.endswith<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'.md'</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #FFA657;">if</span> <span style="color: #79C0FF;">file</span>.patch <span style="color: #FFA657;">and</span> <span style="color: #A1D08E;">'+'</span> <span style="color: #FFA657;">in</span> <span style="color: #79C0FF;">file</span>.patch:
                <span style="color: #f4f4ff;">added_lines</span> = <span style="color: #8c8c8c;">[</span>line<span style="color: #93a8c6;">[</span>1:<span style="color: #93a8c6;">]</span> <span style="color: #FFA657;">for</span> line <span style="color: #FFA657;">in</span> <span style="color: #79C0FF;">file</span>.patch.split<span style="color: #93a8c6;">(</span><span style="color: #A1D08E;">'</span><span style="color: #95a99f;">\n</span><span style="color: #A1D08E;">'</span><span style="color: #93a8c6;">)</span>
                <span style="color: #FFA657;">if</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #A1D08E;">'+'</span><span style="color: #93a8c6;">)</span> <span style="color: #FFA657;">and</span> <span style="color: #FFA657;">not</span> line.startswith<span style="color: #93a8c6;">(</span><span style="color: #A1D08E;">'+++'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">]</span>
                <span style="color: #FFA657;">return</span> added_lines
                <span style="color: #FFA657;">return</span> <span style="color: #8c8c8c;">[]</span>

                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Error getting commit content: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">raise</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">extract_url</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #787878;">"""&#20174;&#34892;&#20013;&#25552;&#21462;URL&#65292;&#25903;&#25345;markdown&#26684;&#24335;&#30340;&#38142;&#25509;"""</span>
                <span style="color: #787878;"># </span><span style="color: #787878;">&#26356;&#26032;&#21518;&#30340;URL&#25552;&#21462;&#27169;&#24335;</span>
                <span style="color: #f4f4ff;">url_pattern</span> = r<span style="color: #A1D08E;">'\((https?://[\w\-._~:/?#\[\]@!$&amp;\'()*+,;=.%]+)\)'</span>
                <span style="color: #FFA657;">match</span> = re.search<span style="color: #8c8c8c;">(</span>url_pattern, line<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">match</span>:
                <span style="color: #FFA657;">return</span> <span style="color: #FFA657;">match</span>.group<span style="color: #8c8c8c;">(</span>1<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> <span style="color: #95a99f;">None</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">has_clip_tag</span><span style="color: #8c8c8c;">(</span>line: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">bool</span>:
                <span style="color: #787878;">"""&#26816;&#26597;&#26159;&#21542;&#21253;&#21547; #2clip &#26631;&#31614;"""</span>
                <span style="color: #FFA657;">return</span> <span style="color: #79C0FF;">bool</span><span style="color: #8c8c8c;">(</span>re.search<span style="color: #93a8c6;">(</span>r<span style="color: #A1D08E;">'#2clip\b'</span>, line<span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">trigger_workflow</span><span style="color: #8c8c8c;">()</span>:
                <span style="color: #787878;">"""&#35302;&#21457;&#21478;&#19968;&#20010;workflow"""</span>
                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">g</span> = Github<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'GITHUB_TOKEN'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">repo</span> = g.get_repo<span style="color: #8c8c8c;">(</span>os.environ<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'GITHUB_REPOSITORY'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #f4f4ff;">workflow</span> = repo.get_workflow<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"bookmark_summary.yml"</span><span style="color: #8c8c8c;">)</span>
                workflow.create_dispatch<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"main"</span><span style="color: #8c8c8c;">)</span>
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Successfully triggered the bookmark_summary workflow"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Failed to trigger workflow: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">raise</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">main</span><span style="color: #8c8c8c;">()</span>:
                <span style="color: #FFA657;">try</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#33719;&#21462;&#25152;&#26377;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
                <span style="color: #f4f4ff;">added_lines</span> = get_added_content<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">not</span> added_lines:
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"No new markdown content found in this commit"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span>

                <span style="color: #f4f4ff;">trigger_needed</span> = <span style="color: #95a99f;">False</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#22788;&#29702;&#27599;&#19968;&#34892;&#26032;&#22686;&#30340;&#20869;&#23481;</span>
                <span style="color: #FFA657;">for</span> line <span style="color: #FFA657;">in</span> added_lines:
                <span style="color: #f4f4ff;">line</span> = line.strip<span style="color: #8c8c8c;">()</span>
                logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Processing line: </span>{line}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#26816;&#26597;&#26631;&#31614;</span>
                <span style="color: #FFA657;">if</span> has_clip_tag<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>:
                <span style="color: #f4f4ff;">trigger_needed</span> = <span style="color: #95a99f;">True</span>
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Found #2clip tag"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#25552;&#21462;&#24182;&#22788;&#29702;URL&#65288;&#26080;&#35770;&#26159;&#21542;&#26377;&#26631;&#31614;&#65289;</span>
                <span style="color: #f4f4ff;">url</span> = extract_url<span style="color: #8c8c8c;">(</span>line<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> url:
                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">response</span> = requests.post<span style="color: #8c8c8c;">(</span>
                url=<span style="color: #A1D08E;">"https://readwise.io/api/v3/save/"</span>,
                headers=<span style="color: #93a8c6;">{</span><span style="color: #A1D08E;">"Authorization"</span>: f<span style="color: #A1D08E;">"Token </span>{os.environ['READWISE_TOKEN']}<span style="color: #A1D08E;">"</span><span style="color: #93a8c6;">}</span>,
                json=<span style="color: #93a8c6;">{</span>
                <span style="color: #A1D08E;">"url"</span>: url,
                <span style="color: #A1D08E;">"tags"</span>: <span style="color: #b0b1a3;">[</span><span style="color: #A1D08E;">"Bookmark"</span><span style="color: #b0b1a3;">]</span>
                <span style="color: #93a8c6;">}</span>
                <span style="color: #8c8c8c;">)</span>
                response.raise_for_status<span style="color: #8c8c8c;">()</span>
                logging.info<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Successfully saved URL: </span>{url}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> requests.exceptions.RequestException <span style="color: #FFA657;">as</span> e:
                logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Failed to save URL </span>{url}<span style="color: #A1D08E;">: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#22914;&#26524;&#21457;&#29616;&#20102;&#26631;&#31614;&#65292;&#35302;&#21457;workflow</span>
                <span style="color: #FFA657;">if</span> trigger_needed:
                logging.info<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Triggering workflow due to #2clip tag"</span><span style="color: #8c8c8c;">)</span>
                trigger_workflow<span style="color: #8c8c8c;">()</span>

                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                logging.error<span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Error: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">raise</span>

                <span style="color: #FFA657;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #A1D08E;">"__main__"</span>:
                main<span style="color: #8c8c8c;">()</span>
              </pre>
            </div>
          </div>
        </div>

        <div id="outline-container-org7398da1" class="outline-3">
          <h3 id="org7398da1">workflow</h3>
          <div class="outline-text-3" id="text-org7398da1">
            <div class="org-src-container">
              <pre class="src src-yaml">
                <span style="color: #f4f4ff;">name</span>: Save Bookmark to Readwise

                <span style="color: #95a99f;">on</span>:
                <span style="color: #f4f4ff;">push</span>:
                <span style="color: #f4f4ff;">branches</span>:
                - main
                <span style="color: #f4f4ff;">paths</span>:
                - <span style="color: #A1D08E;">'**.md'</span>
                <span style="color: #f4f4ff;">workflow_dispatch</span>:

                <span style="color: #f4f4ff;">permissions</span>:
                <span style="color: #f4f4ff;">contents</span>: read
                <span style="color: #f4f4ff;">actions</span>: write

                <span style="color: #f4f4ff;">jobs</span>:
                <span style="color: #f4f4ff;">save-to-readwise</span>:
                <span style="color: #f4f4ff;">runs-on</span>: ubuntu-latest

                <span style="color: #f4f4ff;">steps</span>:
                - <span style="color: #f4f4ff;">name</span>: Checkout repository
                <span style="color: #f4f4ff;">uses</span>: actions/checkout@v4
                <span style="color: #f4f4ff;">with</span>:
                <span style="color: #f4f4ff;">token</span>: ${{ secrets.GITHUB_TOKEN }}

                - <span style="color: #f4f4ff;">name</span>: Set up Python
                <span style="color: #f4f4ff;">uses</span>: actions/setup-python@v4
                <span style="color: #f4f4ff;">with</span>:
                <span style="color: #f4f4ff;">python-version</span>: <span style="color: #A1D08E;">'3.10'</span>

                - <span style="color: #f4f4ff;">name</span>: Install dependencies
                <span style="color: #f4f4ff;">run</span>: |
                <span style="color: #A1D08E;">python -m pip install --upgrade pip</span>
                <span style="color: #A1D08E;">        pip install requests PyGithub</span>

                - <span style="color: #f4f4ff;">name</span>: Run bookmark saver
                <span style="color: #f4f4ff;">env</span>:
                <span style="color: #f4f4ff;">READWISE_TOKEN</span>: ${{ secrets.READWISE_TOKEN }}
                <span style="color: #f4f4ff;">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
                <span style="color: #f4f4ff;">GITHUB_REPOSITORY</span>: ${{ github.repository }}
                <span style="color: #f4f4ff;">run</span>: python save_to_readwise.py

              </pre>
            </div>
          </div>
        </div>
      </div>

      <div id="outline-container-org0887e7a" class="outline-2">
        <h2 id="org0887e7a">Readwise highlights</h2>
        <div class="outline-text-2" id="text-org0887e7a">
          <p>
            写了一个 <code>class ReadwiseAPI</code> 方便其他项目引入。可以定时获取我所有 highlights 的 title 和 url。
          </p>
        </div>

        <div id="outline-container-org253094a" class="outline-3">
          <h3 id="org253094a">python</h3>
          <div class="outline-text-3" id="text-org253094a">
            <div class="org-src-container">
              <pre class="src src-python">
                <span style="color: #FFA657;">import</span> requests
                <span style="color: #FFA657;">import</span> json
                <span style="color: #FFA657;">from</span> datetime <span style="color: #FFA657;">import</span> datetime, timedelta
                <span style="color: #FFA657;">import</span> os
                <span style="color: #FFA657;">from</span> typing <span style="color: #FFA657;">import</span> List, Dict, Optional
                <span style="color: #FFA657;">from</span> pathlib <span style="color: #FFA657;">import</span> Path
                <span style="color: #FFA657;">import</span> re
                <span style="color: #FFA657;">from</span> github <span style="color: #FFA657;">import</span> Github
                <span style="color: #FFA657;">import</span> argparse

                <span style="color: #FFA657;">class</span> <span style="color: #95a99f;">ReadwiseAPI</span>:
                <span style="color: #787878;">"""Readwise API client for exporting highlights with smart update capability and GitHub integration"""</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">__init__</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">Initialize Readwise token</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">readwise_token</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"READWISE_TOKEN"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">not</span> <span style="color: #FFA657;">self</span>.readwise_token:
                <span style="color: #FFA657;">raise</span> <span style="color: #95a99f;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"READWISE_TOKEN not found in environment variables"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Initialize GitHub token</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">github_token</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"GITHUB_TOKEN"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">not</span> <span style="color: #FFA657;">self</span>.github_token:
                <span style="color: #FFA657;">raise</span> <span style="color: #95a99f;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"GITHUB_TOKEN not found in environment variables"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Get repository from GitHub Actions environment variable</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">github_repo</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"GITHUB_REPOSITORY"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">not</span> <span style="color: #FFA657;">self</span>.github_repo:
                <span style="color: #FFA657;">raise</span> <span style="color: #95a99f;">ValueError</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Not running in GitHub Actions environment (GITHUB_REPOSITORY not found)"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Initialize GitHub client</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">github</span> = Github<span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>.github_token<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">repo</span> = <span style="color: #FFA657;">self</span>.github.get_repo<span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>.github_repo<span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Initialize Readwise API settings</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">base_url</span> = <span style="color: #A1D08E;">"https://readwise.io/api/v2"</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">headers</span> = <span style="color: #8c8c8c;">{</span>
                <span style="color: #A1D08E;">"Authorization"</span>: f<span style="color: #A1D08E;">"Token </span>{<span style="color: #FFA657;">self</span>.readwise_token}<span style="color: #A1D08E;">"</span>
                <span style="color: #8c8c8c;">}</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">last_update_file</span> = <span style="color: #A1D08E;">"last_update.json"</span>
                <span style="color: #FFA657;">self</span>.<span style="color: #f4f4ff;">articles_file</span> = <span style="color: #A1D08E;">"articles.json"</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">get_highlights</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, updated_after: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="color: #95a99f;">None</span>,
                start_date: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="color: #95a99f;">None</span>,
                end_date: Optional<span style="color: #93a8c6;">[</span>datetime<span style="color: #93a8c6;">]</span> = <span style="color: #95a99f;">None</span><span style="color: #8c8c8c;">)</span> -&gt; Dict:
                <span style="color: #787878;">"""Get all highlights with their associated metadata"""</span>
                <span style="color: #f4f4ff;">endpoint</span> = f<span style="color: #A1D08E;">"</span>{<span style="color: #FFA657;">self</span>.base_url}<span style="color: #A1D08E;">/export/"</span>
                <span style="color: #f4f4ff;">params</span> = <span style="color: #8c8c8c;">{}</span>

                <span style="color: #FFA657;">if</span> updated_after:
                <span style="color: #f4f4ff;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #A1D08E;">"updated_after"</span><span style="color: #8c8c8c;">]</span> = updated_after.isoformat<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">elif</span> start_date:
                <span style="color: #f4f4ff;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #A1D08E;">"updated_after"</span><span style="color: #8c8c8c;">]</span> = start_date.isoformat<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">if</span> end_date:
                <span style="color: #f4f4ff;">params</span><span style="color: #8c8c8c;">[</span><span style="color: #A1D08E;">"updated_before"</span><span style="color: #8c8c8c;">]</span> = end_date.isoformat<span style="color: #8c8c8c;">()</span>

                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Fetching highlights with params: </span>{params}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">response</span> = requests.get<span style="color: #8c8c8c;">(</span>endpoint, headers=<span style="color: #FFA657;">self</span>.headers, params=params<span style="color: #8c8c8c;">)</span>
                response.raise_for_status<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">return</span> response.json<span style="color: #8c8c8c;">()</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">get_file_content</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, path: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; Optional<span style="color: #8c8c8c;">[</span><span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">]</span>:
                <span style="color: #787878;">"""Get file content from GitHub repository"""</span>
                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">content</span> = <span style="color: #FFA657;">self</span>.repo.get_contents<span style="color: #8c8c8c;">(</span>path<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> content.decoded_content.decode<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'utf-8'</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"File </span>{path}<span style="color: #A1D08E;"> not found in repository: </span>{e}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> <span style="color: #95a99f;">None</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">update_file</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, path: <span style="color: #79C0FF;">str</span>, content: <span style="color: #79C0FF;">str</span>, message: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #787878;">"""Update or create file in GitHub repository"""</span>
                <span style="color: #FFA657;">try</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">Try to get existing file</span>
                <span style="color: #79C0FF;">file</span> = <span style="color: #FFA657;">self</span>.repo.get_contents<span style="color: #8c8c8c;">(</span>path<span style="color: #8c8c8c;">)</span>
                <span style="color: #787878;"># </span><span style="color: #787878;">Update existing file</span>
                <span style="color: #FFA657;">self</span>.repo.update_file<span style="color: #8c8c8c;">(</span>
                path=path,
                message=message,
                content=content,
                sha=<span style="color: #79C0FF;">file</span>.sha
                <span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">Create new file if it doesn't exist</span>
                <span style="color: #FFA657;">self</span>.repo.create_file<span style="color: #8c8c8c;">(</span>
                path=path,
                message=message,
                content=content
                <span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">clean_title</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, title: <span style="color: #79C0FF;">str</span><span style="color: #8c8c8c;">)</span> -&gt; <span style="color: #79C0FF;">str</span>:
                <span style="color: #787878;">"""Clean title by removing newlines and extra spaces"""</span>
                <span style="color: #f4f4ff;">title</span> = re.sub<span style="color: #8c8c8c;">(</span>r<span style="color: #A1D08E;">'\s+'</span>, <span style="color: #A1D08E;">' '</span>, title.replace<span style="color: #93a8c6;">(</span><span style="color: #A1D08E;">'</span><span style="color: #95a99f;">\n</span><span style="color: #A1D08E;">'</span>, <span style="color: #A1D08E;">' '</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> title.strip<span style="color: #8c8c8c;">()</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">create_article_json</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, highlights_data: Dict<span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
                <span style="color: #787878;">"""Create a list of articles with title and URL, only for category 'articles'"""</span>
                <span style="color: #f4f4ff;">articles</span> = <span style="color: #8c8c8c;">[]</span>

                <span style="color: #FFA657;">for</span> article <span style="color: #FFA657;">in</span> highlights_data.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'results'</span>, <span style="color: #93a8c6;">[]</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #FFA657;">if</span> article.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'category'</span>, <span style="color: #A1D08E;">''</span><span style="color: #8c8c8c;">)</span>.lower<span style="color: #8c8c8c;">()</span> == <span style="color: #A1D08E;">'articles'</span>:
                <span style="color: #f4f4ff;">title</span> = <span style="color: #FFA657;">self</span>.clean_title<span style="color: #8c8c8c;">(</span>article.get<span style="color: #93a8c6;">(</span><span style="color: #A1D08E;">'title'</span>, <span style="color: #A1D08E;">'Untitled'</span><span style="color: #93a8c6;">)</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">url</span> = article.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'source_url'</span>, <span style="color: #A1D08E;">''</span><span style="color: #8c8c8c;">)</span>

                articles.append<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">{</span>
                <span style="color: #A1D08E;">'title'</span>: title,
                <span style="color: #A1D08E;">'url'</span>: url
                <span style="color: #93a8c6;">}</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">return</span> articles

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">load_last_update_from_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span><span style="color: #8c8c8c;">)</span> -&gt; Optional<span style="color: #8c8c8c;">[</span>datetime<span style="color: #8c8c8c;">]</span>:
                <span style="color: #787878;">"""Load the last update date from GitHub"""</span>
                <span style="color: #f4f4ff;">content</span> = <span style="color: #FFA657;">self</span>.get_file_content<span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>.last_update_file<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> content:
                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">data</span> = json.loads<span style="color: #8c8c8c;">(</span>content<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> datetime.strptime<span style="color: #8c8c8c;">(</span>data<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'last_update'</span><span style="color: #93a8c6;">]</span>, <span style="color: #A1D08E;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Error parsing last update file: </span>{e}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> <span style="color: #95a99f;">None</span>
                <span style="color: #FFA657;">return</span> <span style="color: #95a99f;">None</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">save_last_update_to_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #787878;">"""Save current date as last update date to GitHub"""</span>
                <span style="color: #f4f4ff;">current_date</span> = datetime.now<span style="color: #8c8c8c;">()</span>.strftime<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">content</span> = json.dumps<span style="color: #8c8c8c;">(</span><span style="color: #93a8c6;">{</span><span style="color: #A1D08E;">'last_update'</span>: current_date<span style="color: #93a8c6;">}</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">self</span>.update_file<span style="color: #8c8c8c;">(</span>
                path=<span style="color: #FFA657;">self</span>.last_update_file,
                content=content,
                message=<span style="color: #A1D08E;">"Update last sync date"</span>
                <span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">load_existing_articles_from_github</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span><span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
                <span style="color: #787878;">"""Load existing articles from GitHub"""</span>
                <span style="color: #f4f4ff;">content</span> = <span style="color: #FFA657;">self</span>.get_file_content<span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>.articles_file<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> content:
                <span style="color: #FFA657;">try</span>:
                <span style="color: #FFA657;">return</span> json.loads<span style="color: #8c8c8c;">(</span>content<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Error parsing articles file: </span>{e}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span> <span style="color: #8c8c8c;">[]</span>
                <span style="color: #FFA657;">return</span> <span style="color: #8c8c8c;">[]</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">merge_articles</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, existing_articles: List<span style="color: #93a8c6;">[</span>Dict<span style="color: #93a8c6;">]</span>, new_articles: List<span style="color: #93a8c6;">[</span>Dict<span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span> -&gt; List<span style="color: #8c8c8c;">[</span>Dict<span style="color: #8c8c8c;">]</span>:
                <span style="color: #787878;">"""Merge new articles with existing ones, avoiding duplicates"""</span>
                <span style="color: #f4f4ff;">existing_set</span> = <span style="color: #8c8c8c;">{</span><span style="color: #93a8c6;">(</span>article<span style="color: #b0b1a3;">[</span><span style="color: #A1D08E;">'title'</span><span style="color: #b0b1a3;">]</span>, article<span style="color: #b0b1a3;">[</span><span style="color: #A1D08E;">'url'</span><span style="color: #b0b1a3;">]</span><span style="color: #93a8c6;">)</span> <span style="color: #FFA657;">for</span> article <span style="color: #FFA657;">in</span> existing_articles<span style="color: #8c8c8c;">}</span>

                <span style="color: #FFA657;">for</span> article <span style="color: #FFA657;">in</span> new_articles:
                <span style="color: #f4f4ff;">article_tuple</span> = <span style="color: #8c8c8c;">(</span>article<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'title'</span><span style="color: #93a8c6;">]</span>, article<span style="color: #93a8c6;">[</span><span style="color: #A1D08E;">'url'</span><span style="color: #93a8c6;">]</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> article_tuple <span style="color: #FFA657;">not</span> <span style="color: #FFA657;">in</span> existing_set:
                existing_articles.append<span style="color: #8c8c8c;">(</span>article<span style="color: #8c8c8c;">)</span>
                existing_set.add<span style="color: #8c8c8c;">(</span>article_tuple<span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">return</span> existing_articles

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">export_articles</span><span style="color: #8c8c8c;">(</span><span style="color: #FFA657;">self</span>, start_date: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="color: #95a99f;">None</span>,
                end_date: Optional<span style="color: #93a8c6;">[</span><span style="color: #79C0FF;">str</span><span style="color: #93a8c6;">]</span> = <span style="color: #95a99f;">None</span>,
                all_time: <span style="color: #79C0FF;">bool</span> = <span style="color: #95a99f;">False</span><span style="color: #8c8c8c;">)</span>:
                <span style="color: #787878;">"""</span>
                <span style="color: #787878;">        Export articles to GitHub with smart update capability</span>

                <span style="color: #787878;">        Args:</span>
                <span style="color: #787878;">            start_date: Optional start date in YYYY-MM-DD format</span>
                <span style="color: #787878;">            end_date: Optional end date in YYYY-MM-DD format</span>
                <span style="color: #787878;">            all_time: If True, fetch all highlights regardless of dates</span>
                <span style="color: #787878;">        """</span>
                <span style="color: #FFA657;">if</span> all_time:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#24403;&#36873;&#25321; all_time &#26102;&#65292;&#24378;&#21046;&#33719;&#21462;&#25152;&#26377; highlights&#65292;&#24573;&#30053;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;</span>
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Fetching all highlights from the beginning"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">highlights_data</span> = <span style="color: #FFA657;">self</span>.get_highlights<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">elif</span> start_date:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#22914;&#26524;&#25351;&#23450;&#20102;&#24320;&#22987;&#26085;&#26399;&#65292;&#20351;&#29992;&#25351;&#23450;&#30340;&#26085;&#26399;&#33539;&#22260;</span>
                <span style="color: #f4f4ff;">start_datetime</span> = datetime.strptime<span style="color: #8c8c8c;">(</span>start_date, <span style="color: #A1D08E;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">end_datetime</span> = datetime.strptime<span style="color: #8c8c8c;">(</span>end_date, <span style="color: #A1D08E;">'%Y-%m-%d'</span><span style="color: #8c8c8c;">)</span> <span style="color: #FFA657;">if</span> end_date <span style="color: #FFA657;">else</span> datetime.now<span style="color: #8c8c8c;">()</span>
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Fetching highlights from </span>{start_date}<span style="color: #A1D08E;"> to </span>{end_date <span style="color: #FFA657;">or</span> 'now'}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">highlights_data</span> = <span style="color: #FFA657;">self</span>.get_highlights<span style="color: #8c8c8c;">(</span>start_date=start_datetime, end_date=end_datetime<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">else</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#20351;&#29992;&#19978;&#27425;&#26356;&#26032;&#26102;&#38388;&#30340;&#22686;&#37327;&#26356;&#26032;&#36923;&#36753;</span>
                <span style="color: #f4f4ff;">last_update</span> = <span style="color: #FFA657;">self</span>.load_last_update_from_github<span style="color: #8c8c8c;">()</span>
                <span style="color: #FFA657;">if</span> last_update:
                <span style="color: #f4f4ff;">days_since_update</span> = <span style="color: #8c8c8c;">(</span>datetime.now<span style="color: #93a8c6;">()</span> - last_update<span style="color: #8c8c8c;">)</span>.days
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Last update was </span>{days_since_update}<span style="color: #A1D08E;"> days ago on </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> days_since_update &gt; 0:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Fetching highlights updated after </span>{last_update.strftime('%Y-%m-%d')}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">highlights_data</span> = <span style="color: #FFA657;">self</span>.get_highlights<span style="color: #8c8c8c;">(</span>updated_after=last_update<span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">else</span>:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"Already updated today, no need to fetch new articles"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">return</span>
                <span style="color: #FFA657;">else</span>:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"No previous update found, fetching all articles"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">highlights_data</span> = <span style="color: #FFA657;">self</span>.get_highlights<span style="color: #8c8c8c;">()</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Create article data</span>
                <span style="color: #f4f4ff;">new_articles</span> = <span style="color: #FFA657;">self</span>.create_article_json<span style="color: #8c8c8c;">(</span>highlights_data<span style="color: #8c8c8c;">)</span>
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Found </span>{<span style="color: #79C0FF;">len</span>(new_articles)}<span style="color: #A1D08E;"> new articles"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Load existing articles</span>
                <span style="color: #f4f4ff;">existing_articles</span> = <span style="color: #FFA657;">self</span>.load_existing_articles_from_github<span style="color: #8c8c8c;">()</span>
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Found </span>{<span style="color: #79C0FF;">len</span>(existing_articles)}<span style="color: #A1D08E;"> existing articles"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Merge new articles with existing ones</span>
                <span style="color: #f4f4ff;">merged_articles</span> = <span style="color: #FFA657;">self</span>.merge_articles<span style="color: #8c8c8c;">(</span>existing_articles, new_articles<span style="color: #8c8c8c;">)</span>
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Total unique articles after merge: </span>{<span style="color: #79C0FF;">len</span>(merged_articles)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Save merged articles to GitHub</span>
                <span style="color: #FFA657;">self</span>.update_file<span style="color: #8c8c8c;">(</span>
                path=<span style="color: #FFA657;">self</span>.articles_file,
                content=json.dumps<span style="color: #93a8c6;">(</span>merged_articles, ensure_ascii=<span style="color: #95a99f;">False</span>, indent=2<span style="color: #93a8c6;">)</span>,
                message=<span style="color: #A1D08E;">"Update articles list"</span>
                <span style="color: #8c8c8c;">)</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">Update the last update date</span>
                <span style="color: #FFA657;">if</span> <span style="color: #FFA657;">not</span> start_date <span style="color: #FFA657;">and</span> <span style="color: #FFA657;">not</span> all_time:  <span style="color: #787878;"># </span><span style="color: #787878;">&#21482;&#26377;&#22312;&#38750;&#25351;&#23450;&#26085;&#26399;&#33539;&#22260;&#21644;&#38750;&#20840;&#37327;&#26356;&#26032;&#30340;&#24773;&#20917;&#19979;&#25165;&#26356;&#26032;&#26368;&#21518;&#21516;&#27493;&#26102;&#38388;</span>
                <span style="color: #FFA657;">self</span>.save_last_update_to_github<span style="color: #8c8c8c;">()</span>

                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"Successfully updated articles in GitHub repository"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">if</span> new_articles:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">"New articles added:"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">for</span> article <span style="color: #FFA657;">in</span> new_articles:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"- </span>{article['title']}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #FFA657;">def</span> <span style="color: #96a6c8;">main</span><span style="color: #8c8c8c;">()</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#20174;&#29615;&#22659;&#21464;&#37327;&#33719;&#21462; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
                <span style="color: #f4f4ff;">gh_start_date</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'INPUT_START_DATE'</span>, <span style="color: #A1D08E;">''</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">gh_end_date</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'INPUT_END_DATE'</span>, <span style="color: #A1D08E;">''</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #f4f4ff;">gh_all_time</span> = os.environ.get<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'INPUT_ALL_TIME'</span>, <span style="color: #A1D08E;">''</span><span style="color: #8c8c8c;">)</span>.lower<span style="color: #8c8c8c;">()</span> == <span style="color: #A1D08E;">'true'</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#35774;&#32622;&#21629;&#20196;&#34892;&#21442;&#25968;&#35299;&#26512;&#22120;</span>
                <span style="color: #f4f4ff;">parser</span> = argparse.ArgumentParser<span style="color: #8c8c8c;">(</span>description=<span style="color: #A1D08E;">'Sync Readwise highlights to GitHub'</span><span style="color: #8c8c8c;">)</span>
                parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'--start-date'</span>, <span style="color: #79C0FF;">type</span>=<span style="color: #79C0FF;">str</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #A1D08E;">'Start date in YYYY-MM-DD format'</span><span style="color: #8c8c8c;">)</span>
                parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'--end-date'</span>, <span style="color: #79C0FF;">type</span>=<span style="color: #79C0FF;">str</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #A1D08E;">'End date in YYYY-MM-DD format'</span><span style="color: #8c8c8c;">)</span>
                parser.add_argument<span style="color: #8c8c8c;">(</span><span style="color: #A1D08E;">'--all-time'</span>, action=<span style="color: #A1D08E;">'store_true'</span>, <span style="color: #79C0FF;">help</span>=<span style="color: #A1D08E;">'Fetch all highlights from the beginning'</span><span style="color: #8c8c8c;">)</span>

                <span style="color: #f4f4ff;">args</span> = parser.parse_args<span style="color: #8c8c8c;">()</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#20248;&#20808;&#20351;&#29992;&#21629;&#20196;&#34892;&#21442;&#25968;&#65292;&#22914;&#26524;&#27809;&#26377;&#21017;&#20351;&#29992; GitHub Actions &#30340;&#36755;&#20837;&#21442;&#25968;</span>
                <span style="color: #f4f4ff;">start_date</span> = args.start_date <span style="color: #FFA657;">or</span> gh_start_date
                <span style="color: #f4f4ff;">end_date</span> = args.end_date <span style="color: #FFA657;">or</span> gh_end_date
                <span style="color: #f4f4ff;">all_time</span> = args.all_time <span style="color: #FFA657;">or</span> gh_all_time

                <span style="color: #FFA657;">try</span>:
                <span style="color: #f4f4ff;">client</span> = ReadwiseAPI<span style="color: #8c8c8c;">()</span>
                client.export_articles<span style="color: #8c8c8c;">(</span>
                start_date=start_date <span style="color: #FFA657;">if</span> start_date <span style="color: #FFA657;">else</span> <span style="color: #95a99f;">None</span>,
                end_date=end_date <span style="color: #FFA657;">if</span> end_date <span style="color: #FFA657;">else</span> <span style="color: #95a99f;">None</span>,
                all_time=all_time
                <span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">except</span> <span style="color: #95a99f;">Exception</span> <span style="color: #FFA657;">as</span> e:
                <span style="color: #79C0FF;">print</span><span style="color: #8c8c8c;">(</span>f<span style="color: #A1D08E;">"An error occurred: </span>{<span style="color: #79C0FF;">str</span>(e)}<span style="color: #A1D08E;">"</span><span style="color: #8c8c8c;">)</span>
                <span style="color: #FFA657;">raise</span>

                <span style="color: #FFA657;">if</span> <span style="color: #79C0FF;">__name__</span> == <span style="color: #A1D08E;">"__main__"</span>:
                main<span style="color: #8c8c8c;">()</span>

              </pre>
            </div>
          </div>
        </div>

        <div id="outline-container-org56cc527" class="outline-3">
          <h3 id="org56cc527">workflow</h3>
          <div class="outline-text-3" id="text-org56cc527">
            <div class="org-src-container">
              <pre class="src src-yaml">
                <span style="color: #f4f4ff;">name</span>: Sync Readwise Articles
                <span style="color: #95a99f;">on</span>:
                <span style="color: #f4f4ff;">schedule</span>:
                <span style="color: #787878;"># </span><span style="color: #787878;">&#27599;&#22825;&#20940;&#26216; 1 &#28857;&#36816;&#34892; (UTC &#26102;&#38388;&#65292;&#23545;&#24212;&#21271;&#20140;&#26102;&#38388; 9 &#28857;)</span>
                - <span style="color: #f4f4ff;">cron</span>: <span style="color: #A1D08E;">'0 1 * * *'</span>

                <span style="color: #787878;"># </span><span style="color: #787878;">&#25903;&#25345;&#25163;&#21160;&#35302;&#21457;&#65292;&#24182;&#28155;&#21152;&#36755;&#20837;&#21442;&#25968;</span>
                <span style="color: #f4f4ff;">workflow_dispatch</span>:
                <span style="color: #f4f4ff;">inputs</span>:
                <span style="color: #f4f4ff;">start_date</span>:
                <span style="color: #f4f4ff;">description</span>: <span style="color: #A1D08E;">'Start date (YYYY-MM-DD, e.g., 2024-01-01)'</span>
                <span style="color: #f4f4ff;">required</span>: <span style="color: #95a99f;">false</span>
                <span style="color: #f4f4ff;">type</span>: string
                <span style="color: #f4f4ff;">default</span>: <span style="color: #A1D08E;">''</span>
                <span style="color: #f4f4ff;">end_date</span>:
                <span style="color: #f4f4ff;">description</span>: <span style="color: #A1D08E;">'End date (YYYY-MM-DD, leave empty for current date)'</span>
                <span style="color: #f4f4ff;">required</span>: <span style="color: #95a99f;">false</span>
                <span style="color: #f4f4ff;">type</span>: string
                <span style="color: #f4f4ff;">default</span>: <span style="color: #A1D08E;">''</span>
                <span style="color: #f4f4ff;">all_time</span>:
                <span style="color: #f4f4ff;">description</span>: <span style="color: #A1D08E;">'Fetch all highlights (overrides date range if selected)'</span>
                <span style="color: #f4f4ff;">type</span>: boolean
                <span style="color: #f4f4ff;">required</span>: <span style="color: #95a99f;">false</span>
                <span style="color: #f4f4ff;">default</span>: <span style="color: #95a99f;">false</span>

                <span style="color: #f4f4ff;">permissions</span>:
                <span style="color: #f4f4ff;">contents</span>: write      <span style="color: #787878;"># </span><span style="color: #787878;">&#20179;&#24211;&#20869;&#23481;&#30340;&#35835;&#20889;&#26435;&#38480;</span>

                <span style="color: #f4f4ff;">jobs</span>:
                <span style="color: #f4f4ff;">sync</span>:
                <span style="color: #f4f4ff;">runs-on</span>: ubuntu-latest

                <span style="color: #f4f4ff;">steps</span>:
                - <span style="color: #f4f4ff;">name</span>: Checkout repository
                <span style="color: #f4f4ff;">uses</span>: actions/checkout@v4

                - <span style="color: #f4f4ff;">name</span>: Set up Python
                <span style="color: #f4f4ff;">uses</span>: actions/setup-python@v5
                <span style="color: #f4f4ff;">with</span>:
                <span style="color: #f4f4ff;">python-version</span>: <span style="color: #A1D08E;">'3.10'</span>
                <span style="color: #f4f4ff;">cache</span>: <span style="color: #A1D08E;">'pip'</span>
                <span style="color: #f4f4ff;">cache-dependency-path</span>: <span style="color: #A1D08E;">'**/requirements.txt'</span>

                - <span style="color: #f4f4ff;">name</span>: Install dependencies
                <span style="color: #f4f4ff;">run</span>: |
                <span style="color: #A1D08E;">python -m pip install --upgrade pip</span>
                <span style="color: #A1D08E;">        pip install -r requirements.txt</span>

                - <span style="color: #f4f4ff;">name</span>: Run sync script
                <span style="color: #f4f4ff;">env</span>:
                <span style="color: #f4f4ff;">READWISE_TOKEN</span>: ${{ secrets.READWISE_TOKEN }}
                <span style="color: #f4f4ff;">GITHUB_TOKEN</span>: ${{ secrets.GITHUB_TOKEN }}
                <span style="color: #f4f4ff;">INPUT_START_DATE</span>: ${{ github.event.inputs.start_date }}
                <span style="color: #f4f4ff;">INPUT_END_DATE</span>: ${{ github.event.inputs.end_date }}
                <span style="color: #f4f4ff;">INPUT_ALL_TIME</span>: ${{ github.event.inputs.all_time }}
                <span style="color: #f4f4ff;">run</span>: python readwise_sync.py

                - <span style="color: #f4f4ff;">name</span>: Check for changes
                <span style="color: #f4f4ff;">id</span>: verify-changed-files
                <span style="color: #f4f4ff;">run</span>: |
                if [ -n <span style="color: #A1D08E;">"$(git status --porcelain)"</span> ]; then
                echo <span style="color: #A1D08E;">"changes_found=true"</span> &gt;&gt; $GITHUB_OUTPUT
                <span style="color: #A1D08E;">        else</span>
                echo <span style="color: #A1D08E;">"changes_found=false"</span> &gt;&gt; $GITHUB_OUTPUT
                <span style="color: #A1D08E;">        fi</span>

                - <span style="color: #f4f4ff;">name</span>: Commit changes
                <span style="color: #f4f4ff;">if</span>: steps.verify-changed-files.outputs.changes_found == <span style="color: #A1D08E;">'true'</span>
                <span style="color: #f4f4ff;">run</span>: |
                git config --local user.email <span style="color: #A1D08E;">"github-actions[bot]@users.noreply.github.com"</span>
                git config --local user.name <span style="color: #A1D08E;">"github-actions[bot]"</span>
                <span style="color: #A1D08E;">        git add articles.json last_update.json</span>
                git commit -m <span style="color: #A1D08E;">"Update Readwise articles [skip ci]"</span> || echo <span style="color: #A1D08E;">"No changes to commit"</span>

                - <span style="color: #f4f4ff;">name</span>: Push changes
                <span style="color: #f4f4ff;">if</span>: steps.verify-changed-files.outputs.changes_found == <span style="color: #A1D08E;">'true'</span>
                <span style="color: #f4f4ff;">uses</span>: ad-m/github-push-action@master
                <span style="color: #f4f4ff;">with</span>:
                <span style="color: #f4f4ff;">github_token</span>: ${{ secrets.GITHUB_TOKEN }}
                <span style="color: #f4f4ff;">branch</span>: ${{ github.ref }}

              </pre>
            </div>
          </div>
        </div>
      </div>
      <div class="taglist"><a href="https://www.vandee.art/tags.html">Tags</a>: <a href="https://www.vandee.art/tag-pkm.html">PKM</a> <a href="https://www.vandee.art/tag-github.html">Github</a> <a href="https://www.vandee.art/tag-python.html">Python</a> </div></div>
    <div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <p>
          © 2022-<script>document.write(new Date().getFullYear())</script> Vandee. All rights reserved.
        </p>
        <div class="social-links"></div>
      </footer>

      <a href="#top" aria-label="go to top" title="Go to Top (Alt + G)"
         class="top-link" id="top-link" accesskey="g">
        <i class="fa-solid fa-angle-up fa-2xl"></i>
      </a>

      <script>
        var mybutton = document.getElementById('top-link');
        window.onscroll = function () {
          if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = 'visible';
            mybutton.style.opacity = '1';
          } else {
            mybutton.style.visibility = 'hidden';
            mybutton.style.opacity = '0';
          }
        };
    </script></div>
  </body>
</html>
